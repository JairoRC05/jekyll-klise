---
layout: 
permalink: /antojitos-salu
---

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cocina Rápida (con Pestañas)</title>
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3ffef; /* Light green background */
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            padding: 1.5rem; /* p-6 */
            margin-bottom: 1.5rem; /* mb-6 */
        }
        /* Custom button styles to match previous Tailwind aesthetic with Bootstrap base */
        .btn-primary {
            background-color: #2563eb; /* blue-600 */
            color: white;
            border: none;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #1d4ed8; /* blue-700 */
        }
        .btn-secondary {
            background-color: #d1d5db; /* gray-300 */
            color: #374151; /* gray-800 */
            border: none;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.2s ease-in-out;
        }
        .btn-secondary:hover {
            background-color: #9ca3af; /* gray-400 */
        }
        .btn-success {
            background-color: #16a34a; /* green-600 */
            color: white;
            border: none;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.2s ease-in-out;
        }
        .btn-success:hover {
            background-color: #15803d; /* green-700 */
        }
        .btn-warning {
            background-color: #f59e0b; /* yellow-500 */
            color: white;
            border: none;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.2s ease-in-out;
        }
        .btn-warning:hover {
            background-color: #d97706; /* yellow-600 */
        }
        .btn-danger {
            background-color: #dc2626; /* red-600 */
            color: white;
            border: none;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.2s ease-in-out;
        }
        .btn-danger:hover {
            background-color: #b91c1c; /* red-700 */
        }

        input[type="text"], input[type="number"], select {
            padding: 0.5rem; /* p-2 */
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            display: block; /* block */
            width: 100%; /* w-full */
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            border-color: #3b82f6; /* focus:border-blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* focus:ring-blue-500 */
            outline: none;
        }
        table {
            width: 100%; /* w-full */
            text-align: left; /* text-left */
            border-collapse: collapse; /* border-collapse */
        }
        th, td {
            padding: 0.75rem; /* p-3 */
            border-bottom: 1px solid #e5e7eb; /* border-b border-gray-200 */
        }
        th {
            background-color: #f3f4f6; /* bg-gray-100 */
            font-weight: 600; /* font-semibold */
            color: #4b5563; /* text-gray-700 */
        }
        /* Estilos para las pestañas principales */
        .tab-button {
            padding: 0.75rem 1.5rem; /* px-6 py-3 */
            font-size: 1.125rem; /* text-lg */
            font-weight: 500; /* font-medium */
            color: #4b5563; /* text-gray-700 */
            border-bottom: 2px solid transparent; /* border-b-2 border-transparent */
            transition: color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .tab-button:hover {
            color: #2563eb; /* hover:text-blue-600 */
            border-color: #2563eb; /* hover:border-blue-600 */
        }
        .tab-button.active {
            color: #2563eb; /* text-blue-600 */
            border-color: #2563eb; /* border-blue-600 */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Estilos para las pestañas anidadas (dentro de Gestión de Pedidos) */
        .order-tab-button {
            padding: 0.5rem 1rem; /* px-4 py-2 */
            font-size: 1rem; /* text-base */
            font-weight: 500; /* font-medium */
            color: #4b5563; /* text-gray-600 */
            border-bottom: 2px solid transparent; /* border-b-2 border-transparent */
            transition: color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .order-tab-button:hover {
            color: #3b82f6; /* hover:text-blue-500 */
            border-color: #3b82f6; /* hover:border-blue-500 */
        }
        .order-tab-button.active {
            color: #3b82f6; /* text-blue-500 */
            border-color: #3b82f6; /* border-blue-500 */
        }
        .order-tab-content {
            display: none;
        }
        .order-tab-content.active {
            display: block;
        }
        .hidden {
            display: none;
        }

        /* Estilos para las pestañas de categoría de productos dentro de "Crear Nuevo Pedido" */
        .product-category-tab-button {
            padding: 0.5rem 1rem; /* px-4 py-2 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #4b5563; /* text-gray-600 */
            border-bottom: 2px solid transparent; /* border-b-2 border-transparent */
            transition: color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .product-category-tab-button:hover {
            color: #16a34a; /* hover:text-green-600 */
            border-color: #16a34a; /* hover:border-green-600 */
        }
        .product-category-tab-button.active {
            color: #16a34a; /* text-green-600 */
            border-color: #16a34a; /* border-green-600 */
        }
        .product-category-tab-content {
            display: none;
        }
        .product-category-tab-content.active {
            display: block;
        }
        /* Styles for product cards */
        .product-card {
            background-color: #ffffff;
            padding: 1rem; /* p-4 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 1px solid #f3f4f6; /* border-gray-100 */
            transition: box-shadow 0.2s ease-in-out;
            height: 100%; /* Ensure cards in grid are same height */
        }
        .product-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* hover:shadow-lg */
        }
        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* space-x-2 */
            margin-top: 0.75rem; /* mt-3 */
        }
        .quantity-btn {
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-700 */
            width: 2rem; /* w-8 */
            height: 2rem; /* h-8 */
            border-radius: 9999px; /* rounded-full */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem; /* text-lg */
            font-weight: 700; /* font-bold */
            transition: background-color 0.2s ease-in-out;
        }
        .quantity-btn:hover {
            background-color: #d1d5db; /* hover:bg-gray-300 */
        }
        .quantity-input {
            width: 4rem; /* w-16 */
            text-align: center;
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding-top: 0.25rem; /* py-1 */
            padding-bottom: 0.25rem; /* py-1 */
        }
        .add-to-order-btn-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* gap-2 */
        }

        /* Custom styles for scrollable areas */
        #productCategoryContent {
            max-height: 500px; /* Adjust as needed */
            overflow-y: auto;
        }

        #currentOrderItems {
            max-height: 400px; /* Adjust as needed */
            overflow-y: auto;
        }

        /* Style for order cards in the status tabs */
        .order-card-container {
            padding: 0.5rem; /* Add some padding around each card in the grid */
        }
    </style>
</head>
<body class="p-4">
    <div class="container mx-auto">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">Sistema de Cocina Rápida</h1>

        <div class="d-flex border-bottom border-gray-200 mb-6">
            <button class="tab-button active" data-tab="products">Gestión de Productos</button>
            <button class="tab-button" data-tab="orders">Gestión de Pedidos</button>
            <button class="tab-button" data-tab="reports">Reportes de Ventas</button>
        </div>

        <div id="products" class="tab-content active card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Gestión de Productos, Categorías y Modificadores</h2>

            <div class="row g-6 mb-6">
                <!-- Buttons to open Modals -->
                <div class="col-12 col-md-4">
                    <button id="openAddProductModalBtn" class="btn btn-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center py-4">
                        <i class="bi bi-plus-circle display-4 mb-2"></i>
                        <span class="fs-5 fw-bold">Agregar/Editar Producto</span>
                    </button>
                </div>
                <div class="col-12 col-md-4">
                    <button id="openAddCategoryModalBtn" class="btn btn-secondary w-100 h-100 d-flex flex-column align-items-center justify-content-center py-4">
                        <i class="bi bi-tags display-4 mb-2"></i>
                        <span class="fs-5 fw-bold">Agregar/Editar Categoría</span>
                    </button>
                </div>
                <div class="col-12 col-md-4">
                    <button id="openManageModifiersModalBtn" class="btn btn-warning w-100 h-100 d-flex flex-column align-items-center justify-content-center py-4">
                        <i class="bi bi-gear display-4 mb-2"></i>
                        <span class="fs-5 fw-bold">Gestión de Modificadores</span>
                    </button>
                </div>
            </div>

            <h3 class="text-xl font-medium text-gray-600 mb-3 mt-4">Productos Existentes</h3>
            <div id="groupedProductsContainer">
                <!-- Grouped product tables will be rendered here -->
            </div>
        </div>

        <div id="orders" class="tab-content card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Gestión de Pedidos</h2>

            <div class="d-flex border-bottom border-gray-200 mb-6">
                <button class="order-tab-button active" data-order-tab="create-order">Crear Nuevo Pedido</button>
                <button class="order-tab-button" data-order-tab="pending-orders-tab">Pedidos Pendientes</button>
                <button class="order-tab-button" data-order-tab="in-process-orders-tab">En Proceso</button>
                <button class="order-tab-button" data-order-tab="delivered-orders-tab">Entregados</button>
                <button class="order-tab-button" data-order-tab="daily-sales-tab">Venta del Día</button>
            </div>

            <div id="create-order" class="order-tab-content active">
                <div class="d-flex flex-column flex-lg-row gap-6">
                    <div class="col-lg-9">
                        <h3 class="text-xl font-medium text-gray-600 mb-3">Productos Disponibles</h3>
                        <div class="card p-4 h-100 d-flex flex-column">
                            <div id="productCategoryTabs" class="d-flex border-bottom border-gray-200 mb-4 overflow-auto">
                                </div>
                            <div id="productCategoryContent" class="flex-grow-1 overflow-auto pe-2 row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4">
                                <p id="noProductsInCategoryMessage" class="text-gray-500 text-center py-4 hidden col-12">No hay productos en esta categoría.</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3">
                        <h3 class="text-xl font-medium text-gray-600 mb-3">Pedido Actual</h3>
                        <div class="card p-4 h-100 d-flex flex-column">
                            <div id="currentOrderItems" class="space-y-2 flex-grow-1 overflow-auto pe-2 mb-4">
                                </div>
                            <div class="d-flex justify-content-between align-items-center mb-4 border-top pt-4">
                                <span class="text-lg font-bold">Total:</span>
                                <span id="currentOrderTotal" class="text-lg font-bold">$0.00</span>
                            </div>
                            <button id="placeOrderBtn" class="btn btn-success w-100"><i class="bi bi-cart-check me-1"></i> Realizar Pedido</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pending-orders-tab" class="order-tab-content">
                <h3 class="text-xl font-medium text-gray-600 mb-3">Pedidos Pendientes</h3>
                <div id="pendingOrders" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 overflow-auto" style="max-height: 24rem;">
                    </div>
            </div>

            <div id="in-process-orders-tab" class="order-tab-content">
                <h3 class="text-xl font-medium text-gray-600 mb-3">Pedidos En Proceso</h3>
                <div id="inProcessOrders" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 overflow-auto" style="max-height: 24rem;">
                    </div>
            </div>

            <div id="delivered-orders-tab" class="order-tab-content">
                <h3 class="text-xl font-medium text-gray-600 mb-3">Pedidos Entregados (Pendiente de Cobro)</h3>
                <div id="deliveredOrders" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 overflow-auto" style="max-height: 24rem;">
                    </div>
            </div>

            <div id="daily-sales-tab" class="order-tab-content">
                <h3 class="text-xl font-medium text-gray-600 mb-3">Ventas del Día</h3>
                <p class="text-lg font-bold text-gray-800 mb-4">Total del Día: <span id="dailySalesTotal">$0.00</span></p>
                <div class="table-responsive rounded-lg shadow-sm mb-4">
                    <table id="dailySalesTable" class="table table-striped min-w-100">
                        <thead>
                            <tr>
                                <th>ID Venta</th>
                                <th>Hora</th>
                                <th>Total</th>
                                <th>Método Pago</th>
                                <th>Productos</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <button id="closeDailySalesBtn" class="btn btn-primary w-100"><i class="bi bi-calendar-check me-1"></i> Cerrar Venta del Día</button>
            </div>

        </div>

        <div id="reports" class="tab-content card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Reportes de Ventas</h2>

            <div class="d-flex flex-column flex-sm-row gap-4 mb-6">
                <div class="mb-3">
                    <label for="reportMonth" class="form-label text-sm font-medium text-gray-700">Mes</label>
                    <select id="reportMonth" class="form-select w-100">
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="reportYear" class="form-label text-sm font-medium text-gray-700">Año</label>
                    <input type="number" id="reportYear" value="2025" class="form-control w-100">
                </div>
                <button id="generateReportBtn" class="btn btn-primary align-self-end"><i class="bi bi-bar-chart me-1"></i> Generar Reporte</button>
            </div>

            <div class="d-flex flex-column flex-sm-row gap-4 mb-6">
                <button id="exportSalesBtn" class="btn btn-secondary w-100 w-sm-auto">Exportar Ventas (JSON)</button>
                <input type="file" id="importSalesFile" accept=".json" class="d-none">
                <button id="importSalesBtn" class="btn btn-secondary w-100 w-sm-auto">Importar Ventas (JSON)</button>
            </div>

            <div id="reportOutput" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h3 class="text-xl font-medium text-gray-600 mb-3">Resultados del Reporte</h3>
                <p id="reportTotalSales" class="text-lg font-semibold text-gray-800">Total de Ingresos: $0.00</p>
                <p id="reportNumSales" class="text-lg font-semibold text-gray-800">Número de Ventas: 0</p>
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Productos Más Vendidos:</h4>
                <ul id="topProductsList" class="list-disc list-inside text-gray-700">
                    </ul>
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Detalle de Ventas:</h4>
                <div class="table-responsive rounded-lg shadow-sm">
                    <table id="salesDetailTable" class="table table-striped min-w-100">
                        <thead>
                            <tr>
                                <th>ID Venta</th>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th>Método Pago</th>
                                <th>Productos</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modifier Selection Modal (Existing) -->
    <div class="modal fade" id="modifierModal" tabindex="-1" aria-labelledby="modifierModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modifierModalLabel">Editar Modificadores para <span id="modalProductNameSpan"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="modalModifiersList" class="space-y-2">
                        </div>
                    <p id="noProductModifiersMessage" class="text-gray-500 text-center py-4 hidden">No hay modificadores disponibles para este producto.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="saveModifiersBtn">Guardar Modificadores</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Add/Edit Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProductModalLabel">Agregar/Editar Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="space-y-4">
                        <div class="mb-3">
                            <label for="addProductModalProductNameInput" class="form-label text-sm font-medium text-gray-700">Nombre del Producto</label>
                            <input type="text" id="addProductModalProductNameInput" placeholder="Ej: Hamburguesa Clásica" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="modalProductDescription" class="form-label text-sm font-medium text-gray-700">Descripción</label>
                            <input type="text" id="modalProductDescription" placeholder="Ej: Carne, lechuga, tomate" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="modalProductPrice" class="form-label text-sm font-medium text-gray-700">Precio</label>
                            <input type="number" id="modalProductPrice" step="0.01" placeholder="Ej: 85.00" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="modalProductCategory" class="form-label text-sm font-medium text-gray-700">Categoría</label>
                            <select id="modalProductCategory" class="form-select">
                                </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveProductModalBtn">Guardar Producto</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Add/Edit Category Modal -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCategoryModalLabel">Agregar/Editar Categoría</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modalCategoryName" class="form-label text-sm font-medium text-gray-700">Nombre de la Categoría</label>
                        <input type="text" id="modalCategoryName" placeholder="Ej: Bebidas" class="form-control">
                    </div>
                    <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Categorías Existentes:</h4>
                    <div class="table-responsive rounded-lg shadow-sm">
                        <table class="table table-striped min-w-100">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="modalCategoryListTableBody">
                                <!-- Categories will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="saveCategoryModalBtn">Guardar Categoría</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Manage Modifiers Modal -->
    <div class="modal fade" id="manageModifiersModal" tabindex="-1" aria-labelledby="manageModifiersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageModifiersModalLabel">Gestión de Modificadores Globales</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3 mb-4">
                        <div class="col-12 col-md-5">
                            <label for="modalModifierNameInput" class="form-label text-sm font-medium text-gray-700">Nombre del Modificador</label>
                            <input type="text" id="modalModifierNameInput" placeholder="Ej: Extra Queso" class="form-control">
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="modalModifierPriceInput" class="form-label text-sm font-medium text-gray-700">Precio</label>
                            <input type="number" id="modalModifierPriceInput" step="0.01" placeholder="Ej: 5.00" class="form-control">
                        </div>
                        <div class="col-12 col-md-3 d-flex align-items-end">
                            <button id="addGlobalModifierModalBtn" class="btn btn-secondary w-100 me-2"><i class="bi bi-plus-circle me-1"></i> Agregar</button>
                            <button id="cancelEditModifierModalBtn" class="btn btn-secondary w-100 hidden"><i class="bi bi-x-circle me-1"></i> Cancelar</button>
                        </div>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Modificadores Existentes:</h4>
                    <div class="table-responsive rounded-lg shadow-sm">
                        <table id="modalGlobalModifiersTable" class="table table-striped min-w-100">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Precio</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Global modifiers will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Global Variables ---
        let productos = [];
        let categorias = [];
        let modificadores = []; // Global array for modifiers
        let pedidos = []; // Orders in queue (Pendiente, En Proceso, Entregado)
        let ventas = [];  // Finalized sales for reports
        let currentOrder = {
            items: [],
            total: 0
        };
        let editingProductId = null; // To track which product is being edited
        let editingCategoryId = null; // New: To track which category is being edited
        let editingModifierId = null; // To track which global modifier is being edited
        let activeProductCategoryId = null; // To track the active category in "Crear Nuevo Pedido" tab
        let currentModifierItemIndex = -1; // To track which item in currentOrder is being modified

        // --- DOM Element Selectors ---
        // Tab Controls (Main)
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // Product & Category Management - Main Page Buttons
        const openAddProductModalBtn = document.getElementById('openAddProductModalBtn');
        const openAddCategoryModalBtn = document.getElementById('openAddCategoryModalBtn');
        const openManageModifiersModalBtn = document.getElementById('openManageModifiersModalBtn');

        // const productsTableBody = document.querySelector('#productsTable tbody'); // This is no longer used for rendering, but kept for consistency if needed elsewhere. (Removed this line as it's not used)
        const groupedProductsContainer = document.getElementById('groupedProductsContainer'); // Container for grouped products
        // const categoryListUl = document.getElementById('categoryList'); // This is no longer used for rendering, but kept for consistency if needed elsewhere. (Removed this line as it's not used)

        // Modals and their internal elements
        const modifierModal = new bootstrap.Modal(document.getElementById('modifierModal')); // Existing modifier selection modal
        const modalProductNameSpan = document.getElementById('modalProductNameSpan'); // For modifier selection modal
        const modalModifiersListDiv = document.getElementById('modalModifiersList'); // For modifier selection modal
        const noProductModifiersMessage = document.getElementById('noProductModifiersMessage'); // For modifier selection modal
        const saveModifiersBtn = document.getElementById('saveModifiersBtn'); // For modifier selection modal

        // NEW: Add/Edit Product Modal Elements
        const addProductModal = new bootstrap.Modal(document.getElementById('addProductModal'));
        const addProductModalLabel = document.getElementById('addProductModalLabel');
        const addProductModalProductNameInput = document.getElementById('addProductModalProductNameInput');
        const modalProductDescriptionInput = document.getElementById('modalProductDescription');
        const modalProductPriceInput = document.getElementById('modalProductPrice');
        const modalProductCategorySelect = document.getElementById('modalProductCategory');
        const saveProductModalBtn = document.getElementById('saveProductModalBtn');

        // NEW: Add/Edit Category Modal Elements
        const addCategoryModal = new bootstrap.Modal(document.getElementById('addCategoryModal'));
        const addCategoryModalLabel = document.getElementById('addCategoryModalLabel'); // New: Category modal title
        const modalCategoryNameInput = document.getElementById('modalCategoryName');
        const saveCategoryModalBtn = document.getElementById('saveCategoryModalBtn'); // Renamed from addCategoryModalBtn
        const modalCategoryListTableBody = document.getElementById('modalCategoryListTableBody'); // New: Table body for categories in modal

        // NEW: Manage Modifiers Modal Elements
        const manageModifiersModal = new bootstrap.Modal(document.getElementById('manageModifiersModal'));
        const modalModifierNameInput = document.getElementById('modalModifierNameInput');
        const modalModifierPriceInput = document.getElementById('modalModifierPriceInput');
        const addGlobalModifierModalBtn = document.getElementById('addGlobalModifierModalBtn');
        const cancelEditModifierModalBtn = document.getElementById('cancelEditModifierModalBtn');
        const modalGlobalModifiersTableBody = document.querySelector('#modalGlobalModifiersTable tbody');


        // Order Management (Nested Tabs)
        const orderTabButtons = document.querySelectorAll('.order-tab-button');
        const orderTabContents = document.querySelectorAll('.order-tab-content');

        // Elements within 'Crear Nuevo Pedido' tab
        const productCategoryTabsContainer = document.getElementById('productCategoryTabs');
        const productCategoryContentDiv = document.getElementById('productCategoryContent');
        const noProductsInCategoryMessageOrders = document.getElementById('noProductsInCategoryMessage'); // Renamed to avoid conflict

        const currentOrderItemsDiv = document.getElementById('currentOrderItems');
        const currentOrderTotalSpan = document.getElementById('currentOrderTotal');
        const placeOrderBtn = document.getElementById('placeOrderBtn');

        // Changed these to be `row` containers in HTML
        const pendingOrdersDiv = document.getElementById('pendingOrders');
        const inProcessOrdersDiv = document.getElementById('inProcessOrders');
        const deliveredOrdersDiv = document.getElementById('deliveredOrders');

        // Daily Sales elements
        const dailySalesTotalSpan = document.getElementById('dailySalesTotal');
        const dailySalesTableBody = document.querySelector('#dailySalesTable tbody');
        const closeDailySalesBtn = document.getElementById('closeDailySalesBtn');


        // Sales Reports
        const reportMonthSelect = document.getElementById('reportMonth');
        const reportYearInput = document.getElementById('reportYear');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const reportTotalSalesP = document.getElementById('reportTotalSales');
        const reportNumSalesP = document.getElementById('reportNumSales');
        const topProductsListUl = document.getElementById('topProductsList');
        const salesDetailTableBody = document.querySelector('#salesDetailTable tbody');

        // Export/Import elements
        const exportSalesBtn = document.getElementById('exportSalesBtn');
        const importSalesFile = document.getElementById('importSalesFile');
        const importSalesBtn = document.getElementById('importSalesBtn');


        // --- Utility Functions for localStorage ---
        function guardarEnLocalStorage(clave, datos) {
            try {
                localStorage.setItem(clave, JSON.stringify(datos));
            } catch (e) {
                console.error("Error al guardar en localStorage:", e);
                Swal.fire({
                    icon: 'error',
                    title: 'Error de Almacenamiento',
                    text: 'No se pudo guardar la información. El almacenamiento local podría estar lleno.',
                });
            }
        }

        function obtenerDeLocalStorage(clave) {
            try {
                const datos = localStorage.getItem(clave);
                return datos ? JSON.parse(datos) : [];
            } catch (e) {
                console.error("Error al obtener de localStorage:", e);
                Swal.fire({
                    icon: 'error',
                    title: 'Error de Lectura',
                    text: 'No se pudieron cargar los datos del almacenamiento local.',
                });
                return []; // Return an empty array in case of parsing error
            }
        }

        // --- Tab Navigation Functions (Main Tabs) ---
        function showTab(tabId) {
            // Remove 'active' from all main tab buttons and content
            tabButtons.forEach(button => button.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            // Add 'active' to the selected main tab button and content
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');

            // Special handling for nested tabs within the 'orders' section
            if (tabId === 'orders') {
                // Initialize the nested order tabs, showing 'create-order' by default
                showOrderTab('create-order');
                renderProductsByCategoryTabs(); // Render category tabs for products
                renderAllOrders(); // Ensure all order lists are updated
                updateCurrentOrderDisplay(); // Ensure current order display is updated
            } else if (tabId === 'products') { // Re-render products and categories when entering product tab
                renderCategories(); // Renders categories in product modal dropdown and category management modal
                renderProducts(); // This now renders grouped products
                // No need to render global modifiers on main page, they are in their modal
            } else if (tabId === 'reports') {
                // Optional: Generate the report automatically when entering the tab
                // generateMonthlyReport();
            }
        }

        // --- Tab Navigation Functions (Nested Order Tabs) ---
        function showOrderTab(orderTabId) {
            // Remove 'active' from all nested order tab buttons and content
            orderTabButtons.forEach(button => button.classList.remove('active'));
            orderTabContents.forEach(content => content.classList.remove('active'));

            // Add 'active' to the selected nested order tab button and content
            document.querySelector(`.order-tab-button[data-order-tab="${orderTabId}"]`).classList.add('active');
            document.getElementById(orderTabId).classList.add('active');

            // Re-render orders when switching between order status tabs
            if (orderTabId === 'pending-orders-tab' || orderTabId === 'in-process-orders-tab' || orderTabId === 'delivered-orders-tab') {
                renderAllOrders();
            } else if (orderTabId === 'create-order') {
                renderProductsByCategoryTabs(); // Re-render product category tabs if returning to create order
            } else if (orderTabId === 'daily-sales-tab') { // NEW: Render daily sales when this tab is active
                renderDailySales();
            }
        }

        // --- Tab Navigation Functions (Product Category Tabs within Create Order) ---
        function showProductCategoryTab(categoryId) {
            // Remove 'active' from all product category tab buttons and content
            document.querySelectorAll('.product-category-tab-button').forEach(button => button.classList.remove('active'));
            // Note: We don't have separate content divs for each product category,
            // instead, we re-render products into productCategoryContentDiv

            // Add 'active' to the selected category tab button
            document.querySelector(`.product-category-tab-button[data-category-id="${categoryId}"]`).classList.add('active');
            activeProductCategoryId = categoryId; // Set the active category
            renderAvailableProductsForOrder(categoryId); // Render products for the selected category
        }


        // --- App Initialization ---
        function initApp() {
            productos = obtenerDeLocalStorage('productos');
            categorias = obtenerDeLocalStorage('categorias');
            modificadores = obtenerDeLocalStorage('modificadores'); // Load global modifiers
            pedidos = obtenerDeLocalStorage('pedidos');
            ventas = obtenerDeLocalStorage('ventas');

            renderCategories(); // Renders categories in product modal dropdown and category management modal
            renderProducts(); // This now renders grouped products on the main products tab
            renderGlobalModifiers(); // Render global modifiers table (for the modal)

            // Set current month and year in report selector
            const today = new Date();
            reportMonthSelect.value = today.getMonth() + 1;
            reportYearInput.value = today.getFullYear();

            // Configure event listeners for main tabs
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    showTab(button.dataset.tab);
                });
            });

            // Configure event listeners for nested order tabs
            orderTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    showOrderTab(button.dataset.orderTab);
                });
            });

            // Show products tab by default on load
            showTab('products');
        }

        // --- Category Management ---

        function renderCategories() {
            // Clear and populate the category select dropdown in the product modal
            modalProductCategorySelect.innerHTML = '<option value="">Selecciona una categoría</option>';

            // Clear and populate the category list table in the category management modal
            modalCategoryListTableBody.innerHTML = '';

            categorias.forEach(cat => {
                // For the product modal's category select dropdown
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.nombre;
                modalProductCategorySelect.appendChild(option);

                // For the category management modal's table
                const row = modalCategoryListTableBody.insertRow();
                row.insertCell().textContent = cat.id;
                row.insertCell().textContent = cat.nombre;

                const actionsCell = row.insertCell();
                const editBtn = document.createElement('button');
                editBtn.innerHTML = '<i class="bi bi-pencil-square"></i>';
                editBtn.className = 'btn btn-secondary btn-sm me-2';
                editBtn.title = 'Editar Categoría';
                editBtn.onclick = () => editCategory(cat.id);
                actionsCell.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                deleteBtn.className = 'btn btn-danger btn-sm';
                deleteBtn.title = 'Eliminar Categoría';
                deleteBtn.onclick = () => deleteCategory(cat.id);
                actionsCell.appendChild(deleteBtn);
            });
        }

        function addCategory() { // Now called by modal button
            const name = modalCategoryNameInput.value.trim();
            if (name) {
                if (editingCategoryId) {
                    // Update existing category
                    const categoryIndex = categorias.findIndex(c => c.id === editingCategoryId);
                    if (categoryIndex !== -1) {
                        categorias[categoryIndex].nombre = name;
                        Swal.fire({
                            icon: 'success',
                            title: 'Categoría Actualizada',
                            text: 'Categoría actualizada exitosamente.',
                            showConfirmButton: false,
                            timer: 1500
                        });
                    }
                } else {
                    // Add new category
                    if (categorias.some(cat => cat.nombre.toLowerCase() === name.toLowerCase())) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Categoría Existente',
                            text: 'La categoría ya existe.',
                        });
                        return;
                    }
                    const newCategory = {
                        id: 'cat_' + Date.now(),
                        nombre: name
                    };
                    categorias.push(newCategory);
                    Swal.fire({
                        icon: 'success',
                        title: 'Categoría Agregada',
                        text: 'Categoría agregada exitosamente.',
                        showConfirmButton: false,
                        timer: 1500
                    });
                }
                guardarEnLocalStorage('categorias', categorias);
                renderCategories(); // Re-render categories in all places
                renderProducts(); // Re-render products to update grouping
                modalCategoryNameInput.value = ''; // Clear modal input
                editingCategoryId = null; // Reset editing state
                addCategoryModalLabel.textContent = 'Agregar/Editar Categoría'; // Reset modal title
                saveCategoryModalBtn.textContent = 'Guardar Categoría'; // Reset modal button text
                // addCategoryModal.hide(); // Keep modal open for continuous adding/editing
                renderProductsByCategoryTabs(); // Update category tabs in order creation
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Campo Vacío',
                    text: 'Por favor, ingresa un nombre para la categoría.',
                });
            }
        }

        function editCategory(id) {
            const category = categorias.find(c => c.id === id);
            if (category) {
                modalCategoryNameInput.value = category.nombre;
                editingCategoryId = id;
                addCategoryModalLabel.textContent = 'Editar Categoría';
                saveCategoryModalBtn.textContent = 'Actualizar Categoría';
                addCategoryModal.show(); // Show the modal for editing
            }
        }

        function deleteCategory(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡Esto eliminará la categoría y los productos asociados quedarán 'Sin categoría'!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Remove the category
                    categorias = categorias.filter(cat => cat.id !== id);

                    // Update products that belonged to this category
                    productos.forEach(prod => {
                        if (prod.categoria === id) {
                            prod.categoria = ''; // Set to empty string or a specific 'uncategorized' ID
                        }
                    });

                    guardarEnLocalStorage('categorias', categorias);
                    guardarEnLocalStorage('productos', productos); // Save updated products
                    renderCategories(); // Re-render categories in all places
                    renderProducts(); // Re-render products to reflect changes
                    renderProductsByCategoryTabs(); // Update category tabs in order creation
                    // If the deleted category was being edited, clear the form
                    if (editingCategoryId === id) {
                        modalCategoryNameInput.value = '';
                        editingCategoryId = null;
                        addCategoryModalLabel.textContent = 'Agregar/Editar Categoría';
                        saveCategoryModalBtn.textContent = 'Guardar Categoría';
                    }
                    Swal.fire(
                        '¡Eliminada!',
                        'La categoría ha sido eliminada.',
                        'success'
                    );
                }
            });
        }

        // --- Product Management ---

        function renderProducts() {
            groupedProductsContainer.innerHTML = ''; // Clear container

            // Group products by category
            const productsByCategory = {};
            productos.forEach(prod => {
                const categoryId = prod.categoria || 'uncategorized'; // Use 'uncategorized' for products without a category
                if (!productsByCategory[categoryId]) {
                    productsByCategory[categoryId] = [];
                }
                productsByCategory[categoryId].push(prod);
            });

            // Get sorted category names for display order
            // Ensure 'Sin categoría' is always at the end
            const sortedCategoryIds = Object.keys(productsByCategory).sort((a, b) => {
                const nameA = (categorias.find(cat => cat.id === a)?.nombre || 'Sin categoría');
                const nameB = (categorias.find(cat => cat.id === b)?.nombre || 'Sin categoría');

                if (nameA === 'Sin categoría') return 1;
                if (nameB === 'Sin categoría') return -1;
                return nameA.localeCompare(nameB);
            });

            if (productos.length === 0) {
                groupedProductsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No hay productos registrados.</p>';
                return;
            }

            sortedCategoryIds.forEach(categoryId => {
                const categoryName = categorias.find(cat => cat.id === categoryId)?.nombre || 'Sin categoría';
                const productsInThisCategory = productsByCategory[categoryId];

                // Sort products within this category alphabetically by name
                productsInThisCategory.sort((a, b) => a.nombre.localeCompare(b.nombre));

                const categoryGroupDiv = document.createElement('div');
                categoryGroupDiv.className = 'category-product-group mb-4';
                categoryGroupDiv.innerHTML = `
                    <h4>${categoryName}</h4>
                    <div class="table-responsive">
                        <table class="table table-striped min-w-100">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Descripción</th>
                                    <th>Precio</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Products for this category will go here -->
                            </tbody>
                        </table>
                    </div>
                `;
                const tableBody = categoryGroupDiv.querySelector('tbody');

                productsInThisCategory.forEach(prod => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = prod.id;
                    row.insertCell().textContent = prod.nombre;
                    row.insertCell().textContent = prod.descripcion;
                    row.insertCell().textContent = `$${prod.precio.toFixed(2)}`;

                    const actionsCell = row.insertCell();
                    const editBtn = document.createElement('button');
                    editBtn.innerHTML = '<i class="bi bi-pencil-square"></i>';
                    editBtn.className = 'btn btn-secondary btn-sm me-2';
                    editBtn.title = 'Editar Producto';
                    editBtn.onclick = () => editProduct(prod.id);
                    actionsCell.appendChild(editBtn);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                    deleteBtn.className = 'btn btn-danger btn-sm';
                    deleteBtn.title = 'Eliminar Producto';
                    deleteBtn.onclick = () => deleteProduct(prod.id);
                    actionsCell.appendChild(deleteBtn);
                });
                groupedProductsContainer.appendChild(categoryGroupDiv);
            });
        }

        function saveProduct() {
            const name = addProductModalProductNameInput.value.trim();
            const description = modalProductDescriptionInput.value.trim();
            const price = parseFloat(modalProductPriceInput.value);
            const categoryId = modalProductCategorySelect.value;

            if (name && description && !isNaN(price) && price > 0 && categoryId) {
                if (editingProductId) {
                    // Update existing product
                    const productIndex = productos.findIndex(p => p.id === editingProductId);
                    if (productIndex !== -1) {
                        productos[productIndex].nombre = name;
                        productos[productIndex].descripcion = description;
                        productos[productIndex].precio = price;
                        productos[productIndex].categoria = categoryId;
                        Swal.fire({
                            icon: 'success',
                            title: 'Producto Actualizado',
                            text: 'Producto actualizado exitosamente.',
                            showConfirmButton: false,
                            timer: 1500
                        });
                    }
                } else {
                    // Add new product
                    const newProduct = {
                        id: 'prod_' + Date.now(),
                        nombre: name,
                        descripcion: description,
                        precio: price,
                        categoria: categoryId,
                    };
                    productos.push(newProduct);
                    Swal.fire({
                        icon: 'success',
                        title: 'Producto Agregado',
                        text: 'Producto agregado exitosamente.',
                        showConfirmButton: false,
                        timer: 1500
                    });
                }
                guardarEnLocalStorage('productos', productos);
                renderProducts(); // Re-render grouped products
                renderAvailableProductsForOrder(activeProductCategoryId); // Update product list for current category in orders
                clearProductFormModal(); // Clear modal form
                addProductModal.hide(); // Close modal
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Campos Incompletos',
                    text: 'Por favor, completa todos los campos del producto correctamente (nombre, descripción, precio > 0 y categoría seleccionada).',
                });
            }
        }

        function editProduct(id) {
            const product = productos.find(p => p.id === id);
            if (product) {
                addProductModalProductNameInput.value = product.nombre;
                modalProductDescriptionInput.value = product.descripcion;
                modalProductPriceInput.value = product.precio;
                modalProductCategorySelect.value = product.categoria;

                editingProductId = id; // Set the product being edited
                addProductModalLabel.textContent = 'Editar Producto'; // Update modal title
                saveProductModalBtn.textContent = 'Actualizar Producto'; // Update modal button text
                addProductModal.show(); // Show modal
            }
        }

        function clearProductFormModal() {
            addProductModalProductNameInput.value = '';
            modalProductDescriptionInput.value = '';
            modalProductPriceInput.value = '';
            modalProductCategorySelect.value = '';
            editingProductId = null; // Reset editing state
            addProductModalLabel.textContent = 'Agregar Nuevo Producto'; // Reset modal title
            saveProductModalBtn.textContent = 'Guardar Producto'; // Reset modal button text
        }

        function deleteProduct(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡No podrás revertir esto!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    productos = productos.filter(prod => prod.id !== id);
                    guardarEnLocalStorage('productos', productos);
                    renderProducts();
                    renderAvailableProductsForOrder(activeProductCategoryId); // Update product list for current category in orders
                    // If the deleted product was being edited, clear the form
                    if (editingProductId === id) {
                        clearProductFormModal();
                    }
                    Swal.fire(
                        '¡Eliminado!',
                        'El producto ha sido eliminado.',
                        'success'
                    );
                }
            });
        }

        // --- Global Modifier Management ---
        function renderGlobalModifiers() {
            modalGlobalModifiersTableBody.innerHTML = ''; // Render into modal table
            modificadores.forEach(mod => {
                const row = modalGlobalModifiersTableBody.insertRow();
                row.insertCell().textContent = mod.id;
                row.insertCell().textContent = mod.name;
                row.insertCell().textContent = `$${mod.price.toFixed(2)}`;

                const actionsCell = row.insertCell();
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Editar';
                editBtn.className = 'btn btn-secondary btn-sm me-2';
                editBtn.onclick = () => editGlobalModifier(mod.id);
                actionsCell.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Eliminar';
                deleteBtn.className = 'btn btn-danger btn-sm';
                deleteBtn.onclick = () => deleteGlobalModifier(mod.id);
                actionsCell.appendChild(deleteBtn);
            });
        }

        function addGlobalModifier() { // Now called by modal button
            const name = modalModifierNameInput.value.trim();
            const price = parseFloat(modalModifierPriceInput.value);

            if (name && !isNaN(price) && price >= 0) {
                if (editingModifierId) {
                    // Update existing modifier
                    const modifierIndex = modificadores.findIndex(m => m.id === editingModifierId);
                    if (modifierIndex !== -1) {
                        modificadores[modifierIndex].name = name;
                        modificadores[modifierIndex].price = price;
                        Swal.fire({
                            icon: 'success',
                            title: 'Modificador Actualizado',
                            text: 'Modificador actualizado exitosamente.',
                            showConfirmButton: false,
                            timer: 1500
                        });
                    }
                } else {
                    // Add new modifier
                    if (modificadores.some(mod => mod.name.toLowerCase() === name.toLowerCase())) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Modificador Existente',
                            text: 'Ya existe un modificador con ese nombre.',
                        });
                        return;
                    }
                    const newModifier = {
                        id: 'mod_' + Date.now(),
                        name: name,
                        price: price
                    };
                    modificadores.push(newModifier);
                    Swal.fire({
                        icon: 'success',
                        title: 'Modificador Agregado',
                        text: 'Modificador agregado exitosamente.',
                        showConfirmButton: false,
                        timer: 1500
                    });
                }
                guardarEnLocalStorage('modificadores', modificadores);
                renderGlobalModifiers(); // Re-render table in modal
                clearModifierFormModal(); // Clear modal form
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Campos Incompletos',
                    text: 'Por favor, ingresa un nombre y un precio válido para el modificador (precio >= 0).',
                });
            }
        }

        function editGlobalModifier(id) {
            const modifier = modificadores.find(m => m.id === id);
            if (modifier) {
                modalModifierNameInput.value = modifier.name;
                modalModifierPriceInput.value = modifier.price;
                editingModifierId = id;
                addGlobalModifierModalBtn.textContent = 'Actualizar'; // Update modal button text
                cancelEditModifierModalBtn.classList.remove('hidden');
            }
        }

        function clearModifierFormModal() {
            modalModifierNameInput.value = '';
            modalModifierPriceInput.value = '';
            editingModifierId = null;
            addGlobalModifierModalBtn.textContent = 'Agregar'; // Reset modal button text
            cancelEditModifierModalBtn.classList.add('hidden');
        }

        function deleteGlobalModifier(id) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡No podrás revertir esto!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    modificadores = modificadores.filter(mod => mod.id !== id);
                    guardarEnLocalStorage('modificadores', modificadores);
                    renderGlobalModifiers(); // Re-render table in modal
                    // Also, remove this modifier from any existing currentOrder items' selectedModifiers if it was there
                    currentOrder.items.forEach(item => {
                        item.selectedModifiers = item.selectedModifiers.filter(selectedMod => selectedMod.id !== id);
                    });
                    updateCurrentOrderDisplay();
                    Swal.fire(
                        '¡Eliminado!',
                        'El modificador ha sido eliminado.',
                        'success'
                    );
                }
            });
        }


        // --- Order Management ---

        function renderProductsByCategoryTabs() {
            productCategoryTabsContainer.innerHTML = '';
            productCategoryContentDiv.innerHTML = ''; // Clear existing product list

            if (categorias.length === 0) {
                productCategoryTabsContainer.innerHTML = '<p class="text-gray-500">No hay categorías. Agrega categorías en Gestión de Productos.</p>';
                return;
            }

            // Create "All Productos" tab
            const allProductsTabButton = document.createElement('button');
            allProductsTabButton.className = 'product-category-tab-button';
            allProductsTabButton.textContent = 'Todos';
            allProductsTabButton.dataset.categoryId = 'all';
            allProductsTabButton.onclick = () => showProductCategoryTab('all');
            productCategoryTabsContainer.appendChild(allProductsTabButton);

            // Create tabs for each category
            categorias.forEach(cat => {
                const button = document.createElement('button');
                button.className = 'product-category-tab-button';
                button.textContent = cat.nombre;
                button.dataset.categoryId = cat.id;
                button.onclick = () => showProductCategoryTab(cat.id);
                productCategoryTabsContainer.appendChild(button);
            });

            // Activate the first category or "All Productos" by default
            if (activeProductCategoryId) {
                showProductCategoryTab(activeProductCategoryId);
            } else if (categorias.length > 0) {
                showProductCategoryTab('all'); // Default to 'all' if no active category
            } else {
                noProductsInCategoryMessageOrders.classList.remove('hidden'); // Use the correct element
                productCategoryContentDiv.appendChild(noProductsInCategoryMessageOrders);
            }
        }

        function renderAvailableProductsForOrder(categoryId) {
            productCategoryContentDiv.innerHTML = ''; // Clear product list
            let productsToRender = [];

            if (categoryId === 'all') {
                productsToRender = [...productos]; // Create a copy to sort
            } else {
                productsToRender = [...productos.filter(prod => prod.categoria === categoryId)]; // Create a copy to sort
            }

            // Sort products by price from highest to lowest
            productsToRender.sort((a, b) => b.precio - a.precio);

            if (productsToRender.length === 0) {
                noProductsInCategoryMessageOrders.classList.remove('hidden'); // Use the correct element
                productCategoryContentDiv.appendChild(noProductsInCategoryMessageOrders);
                return;
            } else {
                noProductsInCategoryMessageOrders.classList.add('hidden'); // Use the correct element
            }

            productsToRender.forEach(prod => {
                const productCard = document.createElement('div');
                productCard.className = 'col'; // Bootstrap column for grid
                productCard.innerHTML = `
                    <div class="product-card">
                        <div class="d-flex justify-content-center mb-2">
                            <img src="https://placehold.co/150x100/ADD8E6/000000?text=${encodeURIComponent(prod.nombre)}" alt="${prod.nombre}" class="rounded object-fit-cover">
                        </div>
                        <div class="text-center mb-2">
                            <p class="fw-semibold fs-5 text-gray-800">${prod.nombre}</p>
                            <p class="text-sm text-gray-600">${prod.descripcion}</p>
                            <p class="fw-bold fs-4 text-blue-600 mt-1">$${prod.precio.toFixed(2)}</p>
                        </div>
                        <div class="quantity-control">
                            <button class="quantity-btn" data-action="decrease" data-product-id="${prod.id}"><i class="bi bi-dash"></i></button>
                            <input type="number" class="quantity-input" value="1" min="1" data-product-id="${prod.id}">
                            <button class="quantity-btn" data-action="increase" data-product-id="${prod.id}"><i class="bi bi-plus"></i></button>
                        </div>
                        <button class="btn btn-primary w-100 mt-3 add-to-order-btn" data-product-id="${prod.id}">
                            <i class="bi bi-cart-plus me-1"></i> Agregar al Pedido
                        </button>
                    </div>
                `;
                productCategoryContentDiv.appendChild(productCard);
            });

            // Add event listeners for quantity controls and "Add to Order" buttons
            productCategoryContentDiv.querySelectorAll('.quantity-btn').forEach(button => {
                button.onclick = (event) => {
                    const productId = event.target.dataset.productId || event.target.closest('button').dataset.productId; // Handle icon click
                    const input = productCategoryContentDiv.querySelector(`.quantity-input[data-product-id="${productId}"]`);
                    let quantity = parseInt(input.value);
                    if (event.target.dataset.action === 'increase' || event.target.closest('button').dataset.action === 'increase') {
                        quantity++;
                    } else if ((event.target.dataset.action === 'decrease' || event.target.closest('button').dataset.action === 'decrease') && quantity > 1) {
                        quantity--;
                    }
                    input.value = quantity;
                };
            });

            productCategoryContentDiv.querySelectorAll('.add-to-order-btn').forEach(button => {
                button.onclick = (event) => {
                    const productId = event.target.dataset.productId || event.target.closest('button').dataset.productId; // Handle icon click
                    const input = productCategoryContentDiv.querySelector(`.quantity-input[data-product-id="${productId}"]`);
                    const quantity = parseInt(input.value);
                    if (quantity > 0) {
                        addToOrder(productId, quantity);
                        input.value = 1; // Reset quantity after adding to order
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Cantidad Inválida',
                            text: 'La cantidad debe ser al menos 1.',
                        });
                    }
                };
            });
        }

        function addToOrder(productId, quantity) {
            const product = productos.find(p => p.id === productId);
            if (product) {
                // Check if the product already exists in the current order
                const existingItemIndex = currentOrder.items.findIndex(item => item.product.id === productId);

                if (existingItemIndex !== -1) {
                    // If it exists, just update the quantity
                    currentOrder.items[existingItemIndex].cantidad += quantity;
                } else {
                    // If it's a new item, add it with selectedModifiers initialized as an empty array
                    currentOrder.items.push({
                        product: { ...product }, // Deep copy product details
                        cantidad: quantity,
                        selectedModifiers: [] // Start with no modifiers selected
                    });
                }
                updateCurrentOrderDisplay();
            }
        }

        function updateCurrentOrderDisplay() {
            currentOrderItemsDiv.innerHTML = '';
            currentOrder.total = 0;
            if (currentOrder.items.length === 0) {
                currentOrderItemsDiv.innerHTML = '<p class="text-gray-500">No hay productos en el pedido.</p>';
                currentOrderTotalSpan.textContent = '$0.00';
                return;
            }

            currentOrder.items.forEach((item, itemIndex) => {
                let itemTotalPrice = item.product.precio; // Start with base product price
                let modifiersDisplay = '';

                if (item.selectedModifiers && item.selectedModifiers.length > 0) {
                    modifiersDisplay = item.selectedModifiers.map((mod, modIndex) => {
                        itemTotalPrice += mod.price; // Add modifier price to item total
                        return `<span class="badge bg-info text-dark me-1">${mod.name} ($${mod.price.toFixed(2)}) <button class="btn-close btn-close-white ms-1 remove-selected-modifier" type="button" aria-label="Remove" data-item-index="${itemIndex}" data-mod-index="${modIndex}"></button></span>`;
                    }).join('');
                    modifiersDisplay = `<div class="d-flex flex-wrap align-items-center mt-1">${modifiersDisplay}</div>`;
                }

                const itemDiv = document.createElement('div');
                itemDiv.className = 'd-flex flex-column bg-white p-2 rounded shadow-sm';
                itemDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-gray-700">${item.cantidad}x ${item.product.nombre}</span>
                        <span class="fw-medium text-gray-800">$${(itemTotalPrice * item.cantidad).toFixed(2)}</span>
                        <div class="d-flex gap-2">
                            <button class="btn btn-info btn-sm edit-modifiers-btn" data-item-index="${itemIndex}" title="Editar Modificadores"><i class="bi bi-pencil-square"></i></button>
                            <button class="btn btn-danger btn-sm remove-order-item-btn" data-index="${itemIndex}"><i class="bi bi-x"></i></button>
                        </div>
                    </div>
                    ${modifiersDisplay}
                `;
                currentOrderItemsDiv.appendChild(itemDiv);
                currentOrder.total += (itemTotalPrice * item.cantidad); // Total of item (base price + modifiers) multiplied by quantity
            });
            currentOrderTotalSpan.textContent = `$${currentOrder.total.toFixed(2)}`;

            // Add event listeners for removing items from the order
            currentOrderItemsDiv.querySelectorAll('.remove-order-item-btn').forEach(button => {
                button.onclick = (event) => {
                    const indexToRemove = parseInt(event.target.dataset.index || event.target.closest('button').dataset.index);
                    currentOrder.items.splice(indexToRemove, 1);
                    updateCurrentOrderDisplay();
                };
            });

            // Add event listeners for removing selected modifiers (from the badge)
            currentOrderItemsDiv.querySelectorAll('.remove-selected-modifier').forEach(button => {
                button.onclick = (event) => {
                    const itemIndex = parseInt(event.target.dataset.itemIndex || event.target.closest('button').dataset.itemIndex);
                    const modIndex = parseInt(event.target.dataset.modIndex || event.target.closest('button').dataset.modIndex);
                    if (currentOrder.items[itemIndex] && currentOrder.items[itemIndex].selectedModifiers) {
                        currentOrder.items[itemIndex].selectedModifiers.splice(modIndex, 1);
                        updateCurrentOrderDisplay();
                    }
                };
            });

            // Add event listeners for editing modifiers (main button)
            currentOrderItemsDiv.querySelectorAll('.edit-modifiers-btn').forEach(button => {
                button.onclick = (event) => {
                    const itemIndex = parseInt(event.target.dataset.itemIndex || event.target.closest('button').dataset.itemIndex);
                    openModifierSelectionModal(itemIndex);
                };
            });
        }

        function openModifierSelectionModal(itemIndex) {
            currentModifierItemIndex = itemIndex;
            const item = currentOrder.items[itemIndex];
            if (!item || !item.product) {
                console.error("Item or product not found for modifier selection.");
                return;
            }

            modalProductNameSpan.textContent = item.product.nombre;
            modalModifiersListDiv.innerHTML = ''; // Clear previous modifiers

            const selectedModifiersIds = new Set(item.selectedModifiers.map(mod => mod.id)); // Use ID for selection

            if (modificadores.length === 0) { // Use global modificadores array
                noProductModifiersMessage.classList.remove('hidden');
            } else {
                noProductModifiersMessage.classList.add('hidden');
                modificadores.forEach(mod => { // Iterate over global modifiers
                    const isChecked = selectedModifiersIds.has(mod.id);
                    const div = document.createElement('div');
                    div.className = 'form-check';
                    div.innerHTML = `
                        <input class="form-check-input modifier-checkbox" type="checkbox" value="${mod.id}" id="modifier-${mod.id}" data-modifier-name="${mod.name}" data-modifier-price="${mod.price}" ${isChecked ? 'checked' : ''}>
                        <label class="form-check-label" for="modifier-${mod.id}">
                            ${mod.name} ($${mod.price.toFixed(2)})
                        </label>
                    `;
                    modalModifiersListDiv.appendChild(div);
                });
            }
            modifierModal.show();
        }

        saveModifiersBtn.addEventListener('click', () => {
            if (currentModifierItemIndex === -1) return;

            const newSelectedModifiers = [];
            modalModifiersListDiv.querySelectorAll('.modifier-checkbox:checked').forEach(checkbox => {
                newSelectedModifiers.push({
                    id: checkbox.value, // Store modifier ID
                    name: checkbox.dataset.modifierName,
                    price: parseFloat(checkbox.dataset.modifierPrice)
                });
            });

            currentOrder.items[currentModifierItemIndex].selectedModifiers = newSelectedModifiers;
            updateCurrentOrderDisplay();
            modifierModal.hide();
        });


        function placeOrder() {
            if (currentOrder.items.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Pedido Vacío',
                    text: 'El pedido está vacío. Por favor, agrega productos.',
                });
                return;
            }

            const newOrder = {
                id: 'pedido_' + Date.now(),
                fecha: new Date().toISOString(),
                // Deep copy items and their selectedModifiers
                items: currentOrder.items.map(item => ({
                    product: { ...item.product }, // Copy product details
                    cantidad: item.cantidad,
                    selectedModifiers: JSON.parse(JSON.stringify(item.selectedModifiers || [])) // Deep copy selected modifiers
                })),
                total: currentOrder.total,
                estado: 'Pendiente' // 'Pendiente', 'En Proceso', 'Entregado'
            };

            pedidos.push(newOrder);
            guardarEnLocalStorage('pedidos', pedidos);
            renderAllOrders();

            // Reset current order
            currentOrder.items = [];
            currentOrder.total = 0;
            updateCurrentOrderDisplay();
            Swal.fire({
                icon: 'success',
                title: 'Pedido Realizado',
                text: `Pedido #${newOrder.id.split('_')[1]} realizado y en cola.`,
                showConfirmButton: false,
                timer: 1500
            });
        }

        function renderAllOrders() {
            // Clear all nested order content divs before re-rendering
            pendingOrdersDiv.innerHTML = '';
            inProcessOrdersDiv.innerHTML = '';
            deliveredOrdersDiv.innerHTML = '';

            // Sort orders by date, oldest first
            const sortedPedidos = [...pedidos].sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

            sortedPedidos.forEach(order => {
                let orderItemsHtml = '';
                let orderTotalWithModifiers = 0;

                order.items.forEach(item => {
                    let itemDisplayPrice = item.product.precio;
                    let itemModifiersHtml = '';
                    if (item.selectedModifiers && item.selectedModifiers.length > 0) {
                        itemModifiersHtml = item.selectedModifiers.map(mod => {
                            itemDisplayPrice += mod.price;
                            return `<span class="text-xs text-gray-500 ms-2">${mod.name} ($${mod.price.toFixed(2)})</span>`;
                        }).join('');
                        itemModifiersHtml = `<div class="d-flex flex-wrap">${itemModifiersHtml}</div>`;
                    }
                    orderItemsHtml += `<li>${item.cantidad}x ${item.product.nombre} ($${(item.cantidad * itemDisplayPrice).toFixed(2)}) ${itemModifiersHtml}</li>`;
                    orderTotalWithModifiers += (item.cantidad * itemDisplayPrice);
                });


                const orderCard = document.createElement('div');
                orderCard.className = 'card p-4 h-100'; // Added h-100 for consistent height in grid
                orderCard.innerHTML = `
                    <h4 class="fw-bold text-lg text-gray-800 mb-2">Pedido #${order.id.split('_')[1]}</h4>
                    <p class="text-sm text-gray-600">Fecha: ${new Date(order.fecha).toLocaleString()}</p>
                    <ul class="list-disc list-inside text-gray-700 text-sm mb-2">
                        ${orderItemsHtml}
                    </ul>
                    <p class="fw-semibold text-gray-800">Total: $${orderTotalWithModifiers.toFixed(2)}</p>
                    <div class="mt-3 d-flex flex-wrap gap-2">
                        ${order.estado === 'Pendiente' ?
                            `<button class="btn btn-warning btn-sm" onclick="changeOrderStatus('${order.id}', 'En Proceso')">Enviar a Proceso</button>` : ''}
                        ${order.estado === 'En Proceso' ?
                            `<button class="btn btn-success btn-sm" onclick="changeOrderStatus('${order.id}', 'Entregado')">Marcar Entregado</button>` : ''}
                        ${order.estado === 'Entregado' ?
                            `<button class="btn btn-primary btn-sm" onclick="completeSale('${order.id}')">Cobrar y Finalizar</button>` : ''}
                        <button class="btn btn-danger btn-sm" onclick="cancelOrder('${order.id}')">Cancelar</button>
                    </div>
                `;

                // Create a column div for the card and append to the respective order div
                const colDiv = document.createElement('div');
                colDiv.className = 'col'; // Bootstrap col class
                colDiv.appendChild(orderCard);

                if (order.estado === 'Pendiente') {
                    pendingOrdersDiv.appendChild(colDiv);
                } else if (order.estado === 'En Proceso') {
                    inProcessOrdersDiv.appendChild(colDiv);
                } else if (order.estado === 'Entregado') {
                    deliveredOrdersDiv.appendChild(colDiv);
                }
            });
            // Display message if no orders in a section
            if (pendingOrdersDiv.innerHTML === '') pendingOrdersDiv.innerHTML = '<p class="text-gray-500 text-center col-12">No hay pedidos pendientes.</p>';
            if (inProcessOrdersDiv.innerHTML === '') inProcessOrdersDiv.innerHTML = '<p class="text-gray-500 text-center col-12">No hay pedidos en proceso.</p>';
            if (deliveredOrdersDiv.innerHTML === '') deliveredOrdersDiv.innerHTML = '<p class="text-gray-500 text-center col-12">No hay pedidos entregados.</p>';
        }

        function changeOrderStatus(orderId, newStatus) {
            const orderIndex = pedidos.findIndex(o => o.id === orderId);
            if (orderIndex !== -1) {
                pedidos[orderIndex].estado = newStatus;
                guardarEnLocalStorage('pedidos', pedidos);
                renderAllOrders();
                Swal.fire({
                    icon: 'info',
                    title: 'Estado Actualizado',
                    text: `El pedido #${orderId.split('_')[1]} ha cambiado a "${newStatus}".`,
                    showConfirmButton: false,
                    timer: 1500
                });
            }
        }

        async function completeSale(orderId) {
            const orderIndex = pedidos.findIndex(o => o.id === orderId);
            if (orderIndex !== -1) {
                const completedOrder = pedidos[orderIndex];

                const { value: metodoPago } = await Swal.fire({
                    title: 'Método de Pago',
                    input: 'select',
                    inputOptions: {
                        'Efectivo': 'Efectivo',
                        'Tarjeta': 'Tarjeta'
                    },
                    inputPlaceholder: 'Selecciona un método de pago',
                    showCancelButton: true,
                    inputValidator: (value) => {
                        if (!value) {
                            return 'Debes seleccionar un método de pago';
                        }
                    }
                });

                if (!metodoPago) {
                    Swal.fire('Cobro Cancelado', '', 'info');
                    return;
                }

                // Recalculate total including modifiers for the final sale record
                let finalSaleTotal = 0;
                const productsSoldWithModifiers = completedOrder.items.map(item => {
                    let itemPriceIncludingModifiers = item.product.precio;
                    if (item.selectedModifiers && item.selectedModifiers.length > 0) {
                        item.selectedModifiers.forEach(mod => {
                            itemPriceIncludingModifiers += mod.price;
                        });
                    }
                    finalSaleTotal += item.cantidad * itemPriceIncludingModifiers;

                    return {
                        id: item.product.id,
                        nombre: item.product.nombre,
                        descripcion: item.product.descripcion, // Added product description
                        cantidad: item.cantidad,
                        precioUnitario: item.product.precio, // Base price
                        selectedModifiers: JSON.parse(JSON.stringify(item.selectedModifiers || [])) // Store selected modifiers
                    };
                });


                const nuevaVenta = {
                    id: 'venta_' + Date.now(),
                    fecha: completedOrder.fecha, // Use original order date
                    total: finalSaleTotal, // Use the recalculated total
                    metodoPago: metodoPago,
                    productosVendidos: productsSoldWithModifiers
                };

                ventas.push(nuevaVenta);
                guardarEnLocalStorage('ventas', ventas);

                // Remove the order from the active orders list
                pedidos.splice(orderIndex, 1);
                guardarEnLocalStorage('pedidos', pedidos);

                renderAllOrders();
                renderDailySales(); // Update daily sales view after a sale is completed
                Swal.fire({
                    icon: 'success',
                    title: 'Venta Registrada',
                    text: `Venta de $${nuevaVenta.total.toFixed(2)} registrada exitosamente.`,
                    showConfirmButton: false,
                    timer: 1500
                });
            }
        }

        function cancelOrder(orderId) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡El pedido será cancelado!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Sí, cancelar pedido',
                cancelButtonText: 'No, mantener'
            }).then((result) => {
                if (result.isConfirmed) {
                    pedidos = pedidos.filter(order => order.id !== orderId);
                    guardarEnLocalStorage('pedidos', pedidos);
                    renderAllOrders();
                    Swal.fire(
                        '¡Cancelado!',
                        'El pedido ha sido cancelado.',
                        'success'
                    );
                }
            });
        }

        // NEW FUNCTION: Render Daily Sales
        function renderDailySales() {
            dailySalesTableBody.innerHTML = '';
            let totalDailySales = 0;
            const today = new Date();
            const todayString = today.toISOString().slice(0, 10); //YYYY-MM-DD

            const salesForToday = ventas.filter(venta => {
                const ventaDate = new Date(venta.fecha);
                return ventaDate.toISOString().slice(0, 10) === todayString;
            });

            if (salesForToday.length === 0) {
                const row = dailySalesTableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 5;
                cell.textContent = 'No hay ventas registradas para hoy.';
                cell.className = 'text-center text-gray-500 py-4';
            } else {
                salesForToday.forEach(venta => {
                    totalDailySales += venta.total;

                    const row = dailySalesTableBody.insertRow();
                    row.insertCell().textContent = venta.id.split('_')[1];
                    row.insertCell().textContent = new Date(venta.fecha).toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit', second: '2-digit' }); // Only time for daily report
                    row.insertCell().textContent = `$${venta.total.toFixed(2)}`;
                    row.insertCell().textContent = venta.metodoPago;
                    const productsCell = row.insertCell();
                    let productsHtml = venta.productosVendidos.map(p => {
                        let modHtml = '';
                        if (p.selectedModifiers && p.selectedModifiers.length > 0) {
                            modHtml = p.selectedModifiers.map(m => `${m.name} ($${m.price.toFixed(2)})`).join(', ');
                            modHtml = ` <span class="text-xs text-gray-500">(${modHtml})</span>`;
                        }
                        return `${p.cantidad}x ${p.nombre}${modHtml}`;
                    }).join('<br>');
                    productsCell.innerHTML = productsHtml;
                });
            }
            dailySalesTotalSpan.textContent = `$${totalDailySales.toFixed(2)}`;
        }


        // --- Sales Reports ---

        function generateMonthlyReport() {
            const mes = parseInt(reportMonthSelect.value);
            const anio = parseInt(reportYearInput.value);

            if (isNaN(mes) || isNaN(anio)) {
                Swal.fire({
                    icon: 'error',
                    title: 'Selección Inválida',
                    text: 'Por favor, selecciona un mes y un año válidos.',
                });
                return;
            }

            const todasLasVentas = obtenerDeLocalStorage('ventas');
            const ventasDelMes = todasLasVentas.filter(venta => {
                const fechaVenta = new Date(venta.fecha);
                return fechaVenta.getMonth() + 1 === mes && fechaVenta.getFullYear() === anio;
            });

            let totalIngresos = 0;
            let cantidadVentas = ventasDelMes.length;
            let productosMasVendidos = {}; // { "Product Name": totalQuantitySold }

            ventasDelMes.forEach(venta => {
                totalIngresos += venta.total; // Total already includes modifiers
                venta.productosVendidos.forEach(item => {
                    // Count base product
                    productosMasVendidos[item.nombre] = (productosMasVendidos[item.nombre] || 0) + item.cantidad;
                    // Count modifiers as separate items for "most sold" if desired, or just sum their prices
                    if (item.selectedModifiers) {
                        item.selectedModifiers.forEach(mod => {
                            productosMasVendidos[`${item.nombre} (${mod.name})`] = (productosMasVendidos[`${item.nombre} (${mod.name})`] || 0) + item.cantidad;
                        });
                    }
                });
            });

            const topProducts = Object.entries(productosMasVendidos)
                .sort(([, a], [, b]) => b - a) // Sort from highest to lowest quantity
                .map(([nombre, cantidad]) => ({ nombre, cantidad }));

            renderReport(totalIngresos, cantidadVentas, topProducts, ventasDelMes);
        }

        function renderReport(totalIngresos, cantidadVentas, topProducts, ventasDetalle) {
            reportTotalSalesP.textContent = `Total de Ingresos: $${totalIngresos.toFixed(2)}`;
            reportNumSalesP.textContent = `Número de Ventas: ${cantidadVentas}`;

            topProductsListUl.innerHTML = '';
            if (topProducts.length > 0) {
                topProducts.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.nombre}: ${item.cantidad} unidades`;
                    topProductsListUl.appendChild(li);
                });
            } else {
                topProductsListUl.innerHTML = '<li class="text-gray-500">No hay productos vendidos en este período.</li>';
            }


            salesDetailTableBody.innerHTML = '';
            if (ventasDetalle.length > 0) {
                ventasDetalle.forEach(venta => {
                    const row = salesDetailTableBody.insertRow();
                    row.insertCell().textContent = venta.id.split('_')[1];
                    row.insertCell().textContent = new Date(venta.fecha).toLocaleString();
                    row.insertCell().textContent = `$${venta.total.toFixed(2)}`;
                    row.insertCell().textContent = venta.metodoPago;
                    const productsCell = row.insertCell();
                    let productsHtml = venta.productosVendidos.map(p => {
                        let modHtml = '';
                        if (p.selectedModifiers && p.selectedModifiers.length > 0) {
                            modHtml = p.selectedModifiers.map(m => `${m.name} ($${m.price.toFixed(2)})`).join(', ');
                            modHtml = ` <span class="text-xs text-gray-500">(${modHtml})</span>`;
                        }
                        return `${p.cantidad}x ${p.nombre}${modHtml}`;
                    }).join('<br>');
                    productsCell.innerHTML = productsHtml;

                    const actionsCell = row.insertCell();
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger btn-sm';
                    deleteBtn.innerHTML = '<i class="bi bi-trash"></i>'; // Bootstrap trash icon
                    deleteBtn.title = 'Eliminar Venta';
                    deleteBtn.onclick = () => deleteSale(venta.id);
                    actionsCell.appendChild(deleteBtn);
                });
            } else {
                const row = salesDetailTableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 6; // Increased colspan to account for new Actions column
                cell.textContent = 'No hay ventas registradas para este período.';
                cell.className = 'text-center text-gray-500 py-4';
            }
        }

        function deleteSale(saleId) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡Esta venta será eliminada permanentemente!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc2626',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Sí, eliminar venta',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    ventas = ventas.filter(venta => venta.id !== saleId);
                    guardarEnLocalStorage('ventas', ventas);
                    generateMonthlyReport(); // Re-render the report after deletion
                    renderDailySales(); // Update daily sales view if a sale from today was deleted
                    Swal.fire(
                        '¡Eliminada!',
                        'La venta ha sido eliminada.',
                        'success'
                    );
                }
            });
        }


        // --- Export/Import Functions ---
        function exportSalesData() {
            const data = obtenerDeLocalStorage('ventas');
            if (data.length === 0) {
                Swal.fire({
                    icon: 'info',
                    title: 'Sin Datos',
                    text: 'No hay datos de ventas para exportar.',
                });
                return;
            }
            const jsonString = JSON.stringify(data, null, 2); // Pretty print JSON
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ventas_backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            Swal.fire({
                icon: 'success',
                title: 'Exportación Exitosa',
                text: 'Datos de ventas exportados exitosamente.',
                showConfirmButton: false,
                timer: 1500
            });
        }

        function importSalesData(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => { // Made async to use await with Swal.fire
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) {
                        throw new Error('El archivo JSON no contiene un array válido de ventas.');
                    }
                    
                    const result = await Swal.fire({
                        title: '¿Importar Datos?',
                        text: "¡Esto sobrescribirá tus ventas actuales! ¿Estás seguro?",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#2563eb',
                        cancelButtonColor: '#6b7280',
                        confirmButtonText: 'Sí, importar',
                        cancelButtonText: 'Cancelar'
                    });

                    if (result.isConfirmed) {
                        ventas = importedData;
                        guardarEnLocalStorage('ventas', ventas);
                        Swal.fire({
                            icon: 'success',
                            title: 'Importación Exitosa',
                            text: 'Datos de ventas importados exitosamente. Genera un nuevo reporte para ver los cambios.',
                            showConfirmButton: false,
                            timer: 2000
                        });
                        generateMonthlyReport();
                        renderDailySales();
                    } else {
                        Swal.fire('Importación Cancelada', '', 'info');
                    }
                } catch (error) {
                    console.error("Error al importar datos:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de Importación',
                        text: `Error al importar el archivo: ${error.message}. Asegúrate de que sea un archivo JSON válido.`,
                    });
                }
            };
            reader.readAsText(file);
        }


        // --- Event Listeners ---
        // Main Tab Buttons
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                showTab(button.dataset.tab);
            });
        });

        // Order Tab Buttons
        orderTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                showOrderTab(button.dataset.orderTab);
            });
        });

        // Product Management Modal Triggers
        openAddProductModalBtn.addEventListener('click', () => {
            clearProductFormModal(); // Ensure form is clean before opening for new product
            addProductModal.show();
        });
        saveProductModalBtn.addEventListener('click', saveProduct); // Save button inside modal

        // Category Management Modal Triggers
        openAddCategoryModalBtn.addEventListener('click', () => {
            modalCategoryNameInput.value = ''; // Clear input before opening
            editingCategoryId = null; // Reset editing state
            addCategoryModalLabel.textContent = 'Agregar/Editar Categoría'; // Reset modal title
            saveCategoryModalBtn.textContent = 'Guardar Categoría'; // Reset modal button text
            renderCategories(); // Re-render categories in the modal table
            addCategoryModal.show();
        });
        saveCategoryModalBtn.addEventListener('click', addCategory); // Save button inside modal (handles add/edit)

        // Modifier Management Modal Triggers
        openManageModifiersModalBtn.addEventListener('click', () => {
            clearModifierFormModal(); // Ensure form is clean
            renderGlobalModifiers(); // Render current modifiers in the modal table
            manageModifiersModal.show();
        });
        addGlobalModifierModalBtn.addEventListener('click', addGlobalModifier); // Add/Update button inside modal
        cancelEditModifierModalBtn.addEventListener('click', clearModifierFormModal); // Cancel button inside modal

        // Order Actions
        placeOrderBtn.addEventListener('click', placeOrder);

        // Report Actions
        generateReportBtn.addEventListener('click', generateMonthlyReport);
        closeDailySalesBtn.addEventListener('click', () => {
            Swal.fire({
                title: '¿Cerrar Venta del Día?',
                text: "Esto no eliminará los datos, solo confirmará el cierre operacional del día.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#2563eb',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Sí, cerrar venta',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Clear the daily sales table and reset the total
                    dailySalesTableBody.innerHTML = '';
                    dailySalesTotalSpan.textContent = '$0.00';
                    
                    Swal.fire(
                        '¡Venta Cerrada!',
                        'Venta del día cerrada exitosamente. Los datos están disponibles en los Reportes de Ventas.',
                        'success'
                    );
                }
            });
        });


        // Export/Import Event Listeners
        exportSalesBtn.addEventListener('click', exportSalesData);
        importSalesBtn.addEventListener('click', () => importSalesFile.click());
        importSalesFile.addEventListener('change', importSalesData);

        // Initialize the app when the DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
