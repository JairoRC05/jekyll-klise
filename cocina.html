---
layout: 
permalink: /antojitos-salu
---
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cocina Rápida (con Pestañas)</title>
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3ffef; /* Light green background */
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            padding: 1.5rem; /* p-6 */
            margin-bottom: 1.5rem; /* mb-6 */
        }
        /* Custom button styles to match previous Tailwind aesthetic with Bootstrap base */
        .btn-primary {
            background-color: #2563eb; /* blue-600 */
            color: white;
            border: none;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #1d4ed8; /* blue-700 */
        }
        .btn-secondary {
            background-color: #d1d5db; /* gray-300 */
            color: #374151; /* gray-800 */
            border: none;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.2s ease-in-out;
        }
        .btn-secondary:hover {
            background-color: #9ca3af; /* gray-400 */
        }
        .btn-success {
            background-color: #16a34a; /* green-600 */
            color: white;
            border: none;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.2s ease-in-out;
        }
        .btn-success:hover {
            background-color: #15803d; /* green-700 */
        }
        .btn-warning {
            background-color: #f59e0b; /* yellow-500 */
            color: white;
            border: none;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.2s ease-in-out;
        }
        .btn-warning:hover {
            background-color: #d97706; /* yellow-600 */
        }
        .btn-danger {
            background-color: #dc2626; /* red-600 */
            color: white;
            border: none;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.2s ease-in-out;
        }
        .btn-danger:hover {
            background-color: #b91c1c; /* red-700 */
        }

        input[type="text"], input[type="number"], select {
            padding: 0.5rem; /* p-2 */
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            display: block; /* block */
            width: 100%; /* w-full */
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            border-color: #3b82f6; /* focus:border-blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); /* focus:ring-blue-500 */
            outline: none;
        }
        table {
            width: 100%; /* w-full */
            text-align: left; /* text-left */
            border-collapse: collapse; /* border-collapse */
        }
        th, td {
            padding: 0.75rem; /* p-3 */
            border-bottom: 1px solid #e5e7eb; /* border-b border-gray-200 */
        }
        th {
            background-color: #f3f4f6; /* bg-gray-100 */
            font-weight: 600; /* font-semibold */
            color: #4b5563; /* text-gray-700 */
        }
        /* Estilos para las pestañas principales */
        .tab-button {
            padding: 0.75rem 1.5rem; /* px-6 py-3 */
            font-size: 1.125rem; /* text-lg */
            font-weight: 500; /* font-medium */
            color: #4b5563; /* text-gray-700 */
            border-bottom: 2px solid transparent; /* border-b-2 border-transparent */
            transition: color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .tab-button:hover {
            color: #2563eb; /* hover:text-blue-600 */
            border-color: #2563eb; /* hover:border-blue-600 */
        }
        .tab-button.active {
            color: #2563eb; /* text-blue-600 */
            border-color: #2563eb; /* border-blue-600 */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Estilos para las pestañas anidadas (dentro de Gestión de Pedidos) */
        .order-tab-button {
            padding: 0.5rem 1rem; /* px-4 py-2 */
            font-size: 1rem; /* text-base */
            font-weight: 500; /* font-medium */
            color: #4b5563; /* text-gray-600 */
            border-bottom: 2px solid transparent; /* border-b-2 border-transparent */
            transition: color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .order-tab-button:hover {
            color: #3b82f6; /* hover:text-blue-500 */
            border-color: #3b82f6; /* hover:border-blue-500 */
        }
        .order-tab-button.active {
            color: #3b82f6; /* text-blue-500 */
            border-color: #3b82f6; /* border-blue-500 */
        }
        .order-tab-content {
            display: none;
        }
        .order-tab-content.active {
            display: block;
        }
        .hidden {
            display: none;
        }

        /* Estilos para las pestañas de categoría de productos dentro de "Crear Nuevo Pedido" */
        .product-category-tab-button {
            padding: 0.5rem 1rem; /* px-4 py-2 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #4b5563; /* text-gray-600 */
            border-bottom: 2px solid transparent; /* border-b-2 border-transparent */
            transition: color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .product-category-tab-button:hover {
            color: #16a34a; /* hover:text-green-600 */
            border-color: #16a34a; /* hover:border-green-600 */
        }
        .product-category-tab-button.active {
            color: #16a34a; /* text-green-600 */
            border-color: #16a34a; /* border-green-600 */
        }
        .product-category-tab-content {
            display: none;
        }
        .product-category-tab-content.active {
            display: block;
        }
        /* Styles for product cards */
        .product-card {
            background-color: #ffffff;
            padding: 1rem; /* p-4 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border: 1px solid #f3f4f6; /* border-gray-100 */
            transition: box-shadow 0.2s ease-in-out;
        }
        .product-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* hover:shadow-lg */
        }
        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* space-x-2 */
            margin-top: 0.75rem; /* mt-3 */
        }
        .quantity-btn {
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-700 */
            width: 2rem; /* w-8 */
            height: 2rem; /* h-8 */
            border-radius: 9999px; /* rounded-full */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem; /* text-lg */
            font-weight: 700; /* font-bold */
            transition: background-color 0.2s ease-in-out;
        }
        .quantity-btn:hover {
            background-color: #d1d5db; /* hover:bg-gray-300 */
        }
        .quantity-input {
            width: 4rem; /* w-16 */
            text-align: center;
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding-top: 0.25rem; /* py-1 */
            padding-bottom: 0.25rem; /* py-1 */
        }
        .add-to-order-btn-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* gap-2 */
        }

        /* Custom styles for scrollable areas */
        #productCategoryContent {
            max-height: 500px; /* Adjust as needed */
            overflow-y: auto;
        }

        #currentOrderItems {
            max-height: 400px; /* Adjust as needed */
            overflow-y: auto;
        }
    </style>
</head>
<body class="p-4">
    <div class="container mx-auto">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-8">Sistema de Cocina Rápida</h1>

        <div class="d-flex border-bottom border-gray-200 mb-6">
            <button class="tab-button active" data-tab="products">Gestión de Productos</button>
            <button class="tab-button" data-tab="orders">Gestión de Pedidos</button>
            <button class="tab-button" data-tab="reports">Reportes de Ventas</button>
        </div>

        <div id="products" class="tab-content active card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Gestión de Productos y Categorías</h2>

            <div class="row g-6 mb-6">
                <div class="col-12 col-md-6">
                    <h3 class="text-xl font-medium text-gray-600 mb-3" id="productFormTitle">Agregar Nuevo Producto</h3>
                    <div class="space-y-4">
                        <div class="mb-3">
                            <label for="productName" class="form-label text-sm font-medium text-gray-700">Nombre del Producto</label>
                            <input type="text" id="productName" placeholder="Ej: Hamburguesa Clásica" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="productDescription" class="form-label text-sm font-medium text-gray-700">Descripción</label>
                            <input type="text" id="productDescription" placeholder="Ej: Carne, lechuga, tomate" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="productPrice" class="form-label text-sm font-medium text-gray-700">Precio</label>
                            <input type="number" id="productPrice" step="0.01" placeholder="Ej: 85.00" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="productCategory" class="form-label text-sm font-medium text-gray-700">Categoría</label>
                            <select id="productCategory" class="form-select">
                                </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-sm font-medium text-gray-700 mt-4">Modificadores (Opcional)</label>
                            <div id="modifiersContainer" class="space-y-2 border border-gray-200 p-3 rounded-md bg-gray-50">
                                <p id="noModifiersMessage" class="text-gray-500 text-sm">No hay modificadores. Haz clic en "Agregar Modificador".</p>
                            </div>
                            <button id="addModifierInputBtn" class="btn btn-secondary btn-sm mt-2"><i class="bi bi-plus-circle me-1"></i> Agregar Modificador</button>
                        </div>
                        <div class="d-flex gap-2">
                            <button id="saveProductBtn" class="btn btn-primary w-100"><i class="bi bi-plus-lg me-1"></i> Agregar Producto</button>
                            <button id="cancelEditBtn" class="btn btn-secondary w-100 hidden"><i class="bi bi-x-circle me-1"></i> Cancelar Edición</button>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-6">
                    <h3 class="text-xl font-medium text-gray-600 mb-3">Agregar Nueva Categoría</h3>
                    <div class="space-y-4">
                        <div class="mb-3">
                            <label for="categoryName" class="form-label text-sm font-medium text-gray-700">Nombre de la Categoría</label>
                            <input type="text" id="categoryName" placeholder="Ej: Bebidas" class="form-control">
                        </div>
                        <button id="addCategoryBtn" class="btn btn-secondary w-100"><i class="bi bi-tags-fill me-1"></i> Agregar Categoría</button>
                    </div>
                    <h3 class="text-xl font-medium text-gray-600 mb-3 mt-6">Categorías Existentes</h3>
                    <ul id="categoryList" class="list-disc list-inside text-gray-700">
                        </ul>
                </div>
            </div>

            <h3 class="text-xl font-medium text-gray-600 mb-3">Productos Existentes</h3>
            <div class="table-responsive rounded-lg shadow-sm">
                <table id="productsTable" class="table table-striped min-w-100">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Descripción</th>
                            <th>Precio</th>
                            <th>Categoría</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

        <div id="orders" class="tab-content card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Gestión de Pedidos</h2>

            <div class="d-flex border-bottom border-gray-200 mb-6">
                <button class="order-tab-button active" data-order-tab="create-order">Crear Nuevo Pedido</button>
                <button class="order-tab-button" data-order-tab="pending-orders-tab">Pedidos Pendientes</button>
                <button class="order-tab-button" data-order-tab="in-process-orders-tab">En Proceso</button>
                <button class="order-tab-button" data-order-tab="delivered-orders-tab">Entregados</button>
            </div>

            <div id="create-order" class="order-tab-content active">
                <div class="d-flex flex-column flex-lg-row gap-6">
                    <div class="col-lg-9">
                        <h3 class="text-xl font-medium text-gray-600 mb-3">Productos Disponibles</h3>
                        <div class="card p-4 h-100 d-flex flex-column">
                            <div id="productCategoryTabs" class="d-flex border-bottom border-gray-200 mb-4 overflow-auto">
                                </div>
                            <div id="productCategoryContent" class="flex-grow-1 overflow-auto pe-2 row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4">
                                <p id="noProductsInCategoryMessage" class="text-gray-500 text-center py-4 hidden col-12">No hay productos en esta categoría.</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3">
                        <h3 class="text-xl font-medium text-gray-600 mb-3">Pedido Actual</h3>
                        <div class="card p-4 h-100 d-flex flex-column">
                            <div id="currentOrderItems" class="space-y-2 flex-grow-1 overflow-auto pe-2 mb-4">
                                </div>
                            <div class="d-flex justify-content-between align-items-center mb-4 border-top pt-4">
                                <span class="text-lg font-bold">Total:</span>
                                <span id="currentOrderTotal" class="text-lg font-bold">$0.00</span>
                            </div>
                            <button id="placeOrderBtn" class="btn btn-success w-100"><i class="bi bi-cart-check me-1"></i> Realizar Pedido</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="pending-orders-tab" class="order-tab-content">
                <h3 class="text-xl font-medium text-gray-600 mb-3">Pedidos Pendientes</h3>
                <div id="pendingOrders" class="space-y-4 overflow-auto pe-2" style="max-height: 24rem;">
                    </div>
            </div>

            <div id="in-process-orders-tab" class="order-tab-content">
                <h3 class="text-xl font-medium text-gray-600 mb-3">Pedidos En Proceso</h3>
                <div id="inProcessOrders" class="space-y-4 overflow-auto pe-2" style="max-height: 24rem;">
                    </div>
            </div>

            <div id="delivered-orders-tab" class="order-tab-content">
                <h3 class="text-xl font-medium text-gray-600 mb-3">Pedidos Entregados (Pendiente de Cobro)</h3>
                <div id="deliveredOrders" class="space-y-4 overflow-auto pe-2" style="max-height: 24rem;">
                    </div>
            </div>
        </div>

        <div id="reports" class="tab-content card">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Reportes de Ventas</h2>

            <div class="d-flex flex-column flex-sm-row gap-4 mb-6">
                <div class="mb-3">
                    <label for="reportMonth" class="form-label text-sm font-medium text-gray-700">Mes</label>
                    <select id="reportMonth" class="form-select w-100">
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="reportYear" class="form-label text-sm font-medium text-gray-700">Año</label>
                    <input type="number" id="reportYear" value="2025" class="form-control w-100">
                </div>
                <button id="generateReportBtn" class="btn btn-primary align-self-end"><i class="bi bi-bar-chart me-1"></i> Generar Reporte</button>
            </div>

            <div class="d-flex flex-column flex-sm-row gap-4 mb-6">
                <button id="exportSalesBtn" class="btn btn-secondary w-100 w-sm-auto">Exportar Ventas (JSON)</button>
                <input type="file" id="importSalesFile" accept=".json" class="d-none">
                <button id="importSalesBtn" class="btn btn-secondary w-100 w-sm-auto">Importar Ventas (JSON)</button>
            </div>

            <div id="reportOutput" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h3 class="text-xl font-medium text-gray-600 mb-3">Resultados del Reporte</h3>
                <p id="reportTotalSales" class="text-lg font-semibold text-gray-800">Total de Ingresos: $0.00</p>
                <p id="reportNumSales" class="text-lg font-semibold text-gray-800">Número de Ventas: 0</p>
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Productos Más Vendidos:</h4>
                <ul id="topProductsList" class="list-disc list-inside text-gray-700">
                    </ul>
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Detalle de Ventas:</h4>
                <div class="table-responsive rounded-lg shadow-sm">
                    <table id="salesDetailTable" class="table table-striped min-w-100">
                        <thead>
                            <tr>
                                <th>ID Venta</th>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th>Método Pago</th>
                                <th>Productos</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Global Variables ---
        let productos = [];
        let categorias = [];
        let pedidos = []; // Orders in queue (Pending, In Process, Delivered)
        let ventas = [];  // Finalized sales for reports
        let currentOrder = {
            items: [],
            total: 0
        };
        let editingProductId = null; // To track which product is being edited
        let activeProductCategoryId = null; // To track the active category in "Create New Order" tab


        // --- DOM Element Selectors ---
        // Tab Controls (Main)
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // Product & Category Management
        const productFormTitle = document.getElementById('productFormTitle');
        const productNameInput = document.getElementById('productName');
        const productDescriptionInput = document.getElementById('productDescription');
        const productPriceInput = document.getElementById('productPrice');
        const productCategorySelect = document.getElementById('productCategory');
        const saveProductBtn = document.getElementById('saveProductBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const productsTableBody = document.querySelector('#productsTable tbody');

        const categoryNameInput = document.getElementById('categoryName');
        const addCategoryBtn = document.getElementById('addCategoryBtn');
        const categoryListUl = document.getElementById('categoryList');

        // Modifiers elements
        const modifiersContainer = document.getElementById('modifiersContainer');
        const addModifierInputBtn = document.getElementById('addModifierInputBtn');
        const noModifiersMessage = document.getElementById('noModifiersMessage');


        // Order Management (Nested Tabs)
        const orderTabButtons = document.querySelectorAll('.order-tab-button');
        const orderTabContents = document.querySelectorAll('.order-tab-content');

        // Elements within 'Create New Order' tab
        const productCategoryTabsContainer = document.getElementById('productCategoryTabs');
        const productCategoryContentDiv = document.getElementById('productCategoryContent');
        const noProductsInCategoryMessage = document.getElementById('noProductsInCategoryMessage');

        // const availableProductsDiv = document.getElementById('availableProducts'); // This is now productCategoryContentDiv
        const currentOrderItemsDiv = document.getElementById('currentOrderItems');
        const currentOrderTotalSpan = document.getElementById('currentOrderTotal');
        const placeOrderBtn = document.getElementById('placeOrderBtn');

        const pendingOrdersDiv = document.getElementById('pendingOrders');
        const inProcessOrdersDiv = document.getElementById('inProcessOrders');
        const deliveredOrdersDiv = document.getElementById('deliveredOrders');


        // Sales Reports
        const reportMonthSelect = document.getElementById('reportMonth');
        const reportYearInput = document.getElementById('reportYear');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const reportTotalSalesP = document.getElementById('reportTotalSales');
        const reportNumSalesP = document.getElementById('reportNumSales');
        const topProductsListUl = document.getElementById('topProductsList');
        const salesDetailTableBody = document.querySelector('#salesDetailTable tbody');

        // Export/Import elements
        const exportSalesBtn = document.getElementById('exportSalesBtn');
        const importSalesFile = document.getElementById('importSalesFile');
        const importSalesBtn = document.getElementById('importSalesBtn');


        // --- Utility Functions for localStorage ---
        function guardarEnLocalStorage(clave, datos) {
            try {
                localStorage.setItem(clave, JSON.stringify(datos));
            } catch (e) {
                console.error("Error al guardar en localStorage:", e);
                alert("Error: No se pudo guardar la información. El almacenamiento local podría estar lleno.");
            }
        }

        function obtenerDeLocalStorage(clave) {
            try {
                const datos = localStorage.getItem(clave);
                return datos ? JSON.parse(datos) : [];
            } catch (e) {
                console.error("Error al obtener de localStorage:", e);
                return []; // Return an empty array in case of parsing error
            }
        }

        // --- Tab Navigation Functions (Main Tabs) ---
        function showTab(tabId) {
            // Remove 'active' from all main tab buttons and content
            tabButtons.forEach(button => button.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            // Add 'active' to the selected main tab button and content
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');

            // Special handling for nested tabs within the 'orders' section
            if (tabId === 'orders') {
                // Initialize the nested order tabs, showing 'create-order' by default
                showOrderTab('create-order');
                renderProductsByCategoryTabs(); // Render category tabs for products
                renderAllOrders(); // Ensure all order lists are updated
                updateCurrentOrderDisplay(); // Ensure current order display is updated
            } else if (tabId === 'reports') {
                // Optional: Generate the report automatically when entering the tab
                // generateMonthlyReport();
            }
        }

        // --- Tab Navigation Functions (Nested Order Tabs) ---
        function showOrderTab(orderTabId) {
            // Remove 'active' from all nested order tab buttons and content
            orderTabButtons.forEach(button => button.classList.remove('active'));
            orderTabContents.forEach(content => content.classList.remove('active'));

            // Add 'active' to the selected nested order tab button and content
            document.querySelector(`.order-tab-button[data-order-tab="${orderTabId}"]`).classList.add('active');
            document.getElementById(orderTabId).classList.add('active');

            // Re-render orders when switching between order status tabs
            if (orderTabId === 'pending-orders-tab' || orderTabId === 'in-process-orders-tab' || orderTabId === 'delivered-orders-tab') {
                renderAllOrders();
            } else if (orderTabId === 'create-order') {
                renderProductsByCategoryTabs(); // Re-render product category tabs if returning to create order
            }
        }

        // --- Tab Navigation Functions (Product Category Tabs within Create Order) ---
        function showProductCategoryTab(categoryId) {
            // Remove 'active' from all product category tab buttons and content
            document.querySelectorAll('.product-category-tab-button').forEach(button => button.classList.remove('active'));
            // Note: We don't have separate content divs for each product category,
            // instead, we re-render products into productCategoryContentDiv

            // Add 'active' to the selected category tab button
            document.querySelector(`.product-category-tab-button[data-category-id="${categoryId}"]`).classList.add('active');
            activeProductCategoryId = categoryId; // Set the active category
            renderAvailableProductsForOrder(categoryId); // Render products for the selected category
        }


        // --- App Initialization ---
        function initApp() {
            productos = obtenerDeLocalStorage('productos');
            categorias = obtenerDeLocalStorage('categorias');
            pedidos = obtenerDeLocalStorage('pedidos');
            ventas = obtenerDeLocalStorage('ventas');

            renderCategories();
            renderProducts();
            // Initial rendering for order section is now handled by showOrderTab('create-order')
            // when the main 'orders' tab is activated.

            // Set current month and year in report selector
            const today = new Date();
            reportMonthSelect.value = today.getMonth() + 1;
            reportYearInput.value = today.getFullYear();

            // Configure event listeners for main tabs
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    showTab(button.dataset.tab);
                });
            });

            // Configure event listeners for nested order tabs
            orderTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    showOrderTab(button.dataset.orderTab);
                });
            });

            // Show products tab by default on load
            showTab('products');
        }

        // --- Product and Category Management ---

        function renderCategories() {
            // Clear list and select
            categoryListUl.innerHTML = '';
            productCategorySelect.innerHTML = '<option value="">Selecciona una categoría</option>';

            categorias.forEach(cat => {
                const li = document.createElement('li');
                li.textContent = cat.nombre;
                categoryListUl.appendChild(li);

                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.nombre;
                productCategorySelect.appendChild(option);
            });
        }

        function addCategory() {
            const name = categoryNameInput.value.trim();
            if (name) {
                if (categorias.some(cat => cat.nombre.toLowerCase() === name.toLowerCase())) {
                    alert('La categoría ya existe.');
                    return;
                }
                const newCategory = {
                    id: 'cat_' + Date.now(),
                    nombre: name
                };
                categorias.push(newCategory);
                guardarEnLocalStorage('categorias', categorias);
                renderCategories();
                categoryNameInput.value = '';
                renderProductsByCategoryTabs(); // Update category tabs in order creation
            } else {
                alert('Por favor, ingresa un nombre para la categoría.');
            }
        }

        function renderProducts() {
            productsTableBody.innerHTML = ''; // Clear table
            productos.forEach(prod => {
                const row = productsTableBody.insertRow();
                row.insertCell().textContent = prod.id;
                row.insertCell().textContent = prod.nombre;
                row.insertCell().textContent = prod.descripcion;
                row.insertCell().textContent = `$${prod.precio.toFixed(2)}`;
                const categoryName = categorias.find(cat => cat.id === prod.categoria)?.nombre || 'Sin categoría';
                row.insertCell().textContent = categoryName;

                const actionsCell = row.insertCell();
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Editar';
                editBtn.className = 'btn btn-secondary btn-sm me-2';
                editBtn.onclick = () => editProduct(prod.id);
                actionsCell.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Eliminar';
                deleteBtn.className = 'btn btn-danger btn-sm';
                deleteBtn.onclick = () => deleteProduct(prod.id);
                actionsCell.appendChild(deleteBtn);
            });
        }

        function saveProduct() { // Renamed from addProduct
            const name = productNameInput.value.trim();
            const description = productDescriptionInput.value.trim();
            const price = parseFloat(productPriceInput.value);
            const categoryId = productCategorySelect.value;
            const modifiers = collectModifierInputs(); // Collect modifiers from the form

            if (name && description && !isNaN(price) && price > 0 && categoryId) {
                if (editingProductId) {
                    // Update existing product
                    const productIndex = productos.findIndex(p => p.id === editingProductId);
                    if (productIndex !== -1) {
                        productos[productIndex].nombre = name;
                        productos[productIndex].descripcion = description;
                        productos[productIndex].precio = price;
                        productos[productIndex].categoria = categoryId;
                        productos[productIndex].modifiers = modifiers; // Save modifiers
                        alert('Producto actualizado exitosamente.');
                    }
                    editingProductId = null; // Reset editing state
                    productFormTitle.textContent = 'Agregar Nuevo Producto';
                    saveProductBtn.innerHTML = '<i class="bi bi-plus-lg me-1"></i> Agregar Producto';
                    cancelEditBtn.classList.add('hidden');
                } else {
                    // Add new product
                    const newProduct = {
                        id: 'prod_' + Date.now(),
                        nombre: name,
                        descripcion: description,
                        precio: price,
                        categoria: categoryId,
                        modifiers: modifiers // Save modifiers
                    };
                    productos.push(newProduct);
                    alert('Producto agregado exitosamente.');
                }
                guardarEnLocalStorage('productos', productos);
                renderProducts();
                renderAvailableProductsForOrder(activeProductCategoryId); // Update product list for current category in orders
                clearProductForm();
            } else {
                alert('Por favor, completa todos los campos del producto correctamente.');
            }
        }

        function editProduct(id) {
            const product = productos.find(p => p.id === id);
            if (product) {
                productNameInput.value = product.nombre;
                productDescriptionInput.value = product.descripcion;
                productPriceInput.value = product.precio;
                productCategorySelect.value = product.categoria;
                renderModifierInputs(product.modifiers || []); // Populate modifiers

                editingProductId = id; // Set the product being edited
                productFormTitle.textContent = 'Editar Producto';
                saveProductBtn.innerHTML = '<i class="bi bi-pencil-fill me-1"></i> Actualizar Producto';
                cancelEditBtn.classList.remove('hidden');
            }
        }

        function cancelEdit() {
            clearProductForm();
            editingProductId = null;
            productFormTitle.textContent = 'Agregar Nuevo Producto';
            saveProductBtn.innerHTML = '<i class="bi bi-plus-lg me-1"></i> Agregar Producto';
            cancelEditBtn.classList.add('hidden');
        }

        function clearProductForm() {
            productNameInput.value = '';
            productDescriptionInput.value = '';
            productPriceInput.value = '';
            productCategorySelect.value = '';
            renderModifierInputs([]); // Clear modifiers
        }

        function deleteProduct(id) {
            if (confirm('¿Estás seguro de que quieres eliminar este producto?')) {
                productos = productos.filter(prod => prod.id !== id);
                guardarEnLocalStorage('productos', productos);
                renderProducts();
                renderAvailableProductsForOrder(activeProductCategoryId); // Update product list for current category in orders
                // If the deleted product was being edited, clear the form
                if (editingProductId === id) {
                    cancelEdit();
                }
            }
        }

        // --- Modifier Management (Product Form) ---
        function addModifierInput(name = '', price = '') {
            noModifiersMessage.classList.add('hidden'); // Hide "No modifiers" message

            const modifierDiv = document.createElement('div');
            modifierDiv.className = 'd-flex gap-2 align-items-center';
            modifierDiv.innerHTML = `
                <input type="text" class="modifier-name form-control form-control-sm flex-grow-1" placeholder="Nombre (Ej: Extra Queso)" value="${name}">
                <input type="number" class="modifier-price form-control form-control-sm w-25" step="0.01" placeholder="Precio" value="${price}">
                <button class="btn btn-danger btn-sm remove-modifier-btn"><i class="bi bi-x"></i></button>
            `;
            modifiersContainer.appendChild(modifierDiv);

            // Add event listener to the new remove button
            modifierDiv.querySelector('.remove-modifier-btn').onclick = (event) => {
                modifierDiv.remove();
                if (modifiersContainer.children.length === 0) {
                    noModifiersMessage.classList.remove('hidden'); // Show message if no modifiers left
                }
            };
        }

        function renderModifierInputs(modifiers) {
            modifiersContainer.innerHTML = ''; // Clear existing inputs
            if (modifiers.length > 0) {
                noModifiersMessage.classList.add('hidden');
                modifiers.forEach(mod => addModifierInput(mod.name, mod.price));
            } else {
                noModifiersMessage.classList.remove('hidden');
            }
        }

        function collectModifierInputs() {
            const collectedModifiers = [];
            modifiersContainer.querySelectorAll('.d-flex.gap-2.align-items-center').forEach(modifierDiv => {
                const nameInput = modifierDiv.querySelector('.modifier-name');
                const priceInput = modifierDiv.querySelector('.modifier-price');
                const name = nameInput.value.trim();
                const price = parseFloat(priceInput.value);

                if (name && !isNaN(price)) {
                    collectedModifiers.push({ name: name, price: price });
                }
            });
            return collectedModifiers;
        }

        // --- Order Management ---

        function renderProductsByCategoryTabs() {
            productCategoryTabsContainer.innerHTML = '';
            productCategoryContentDiv.innerHTML = ''; // Clear existing product list

            if (categorias.length === 0) {
                productCategoryTabsContainer.innerHTML = '<p class="text-gray-500">No hay categorías. Agrega categorías en Gestión de Productos.</p>';
                return;
            }

            // Create "All Products" tab
            const allProductsTabButton = document.createElement('button');
            allProductsTabButton.className = 'product-category-tab-button';
            allProductsTabButton.textContent = 'Todos';
            allProductsTabButton.dataset.categoryId = 'all';
            allProductsTabButton.onclick = () => showProductCategoryTab('all');
            productCategoryTabsContainer.appendChild(allProductsTabButton);

            // Create tabs for each category
            categorias.forEach(cat => {
                const button = document.createElement('button');
                button.className = 'product-category-tab-button';
                button.textContent = cat.nombre;
                button.dataset.categoryId = cat.id;
                button.onclick = () => showProductCategoryTab(cat.id);
                productCategoryTabsContainer.appendChild(button);
            });

            // Activate the first category or "All Products" by default
            if (activeProductCategoryId) {
                showProductCategoryTab(activeProductCategoryId);
            } else if (categorias.length > 0) {
                showProductCategoryTab('all'); // Default to 'all' if no active category
            } else {
                productCategoryContentDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No hay productos disponibles.</p>';
            }
        }

        function renderAvailableProductsForOrder(categoryId) {
            productCategoryContentDiv.innerHTML = ''; // Clear product list
            let productsToRender = [];

            if (categoryId === 'all') {
                productsToRender = [...productos]; // Create a copy to sort
            } else {
                productsToRender = [...productos.filter(prod => prod.categoria === categoryId)]; // Create a copy to sort
            }

            // Sort products by price from highest to lowest
            productsToRender.sort((a, b) => b.precio - a.precio);

            if (productsToRender.length === 0) {
                noProductsInCategoryMessage.classList.remove('hidden');
                productCategoryContentDiv.appendChild(noProductsInCategoryMessage);
                return;
            } else {
                noProductsInCategoryMessage.classList.add('hidden');
            }

            productsToRender.forEach(prod => {
                const productCard = document.createElement('div');
                productCard.className = 'col'; // Bootstrap column for grid
                productCard.innerHTML = `
                    <div class="product-card">
                        <div class="d-flex justify-content-center mb-2">
                            <img src="https://placehold.co/150x100/ADD8E6/000000?text=${encodeURIComponent(prod.nombre)}" alt="${prod.nombre}" class="rounded object-fit-cover">
                        </div>
                        <div class="text-center mb-2">
                            <p class="fw-semibold fs-5 text-gray-800">${prod.nombre}</p>
                            <p class="text-sm text-gray-600">${prod.descripcion}</p>
                            <p class="fw-bold fs-4 text-blue-600 mt-1">$${prod.precio.toFixed(2)}</p>
                        </div>
                        ${prod.modifiers && prod.modifiers.length > 0 ?
                            `<div class="text-xs text-gray-500 text-center mb-2">Modificadores: ${prod.modifiers.map(m => `${m.name} ($${m.price.toFixed(2)})`).join(', ')}</div>` : ''}
                        <div class="quantity-control">
                            <button class="quantity-btn" data-action="decrease" data-product-id="${prod.id}"><i class="bi bi-dash"></i></button>
                            <input type="number" class="quantity-input" value="1" min="1" data-product-id="${prod.id}">
                            <button class="quantity-btn" data-action="increase" data-product-id="${prod.id}"><i class="bi bi-plus"></i></button>
                        </div>
                        <button class="btn btn-primary w-100 mt-3 add-to-order-btn" data-product-id="${prod.id}">
                            <i class="bi bi-cart-plus me-1"></i> Agregar al Pedido
                        </button>
                    </div>
                `;
                productCategoryContentDiv.appendChild(productCard);
            });

            // Add event listeners for quantity controls and "Add to Order" buttons
            productCategoryContentDiv.querySelectorAll('.quantity-btn').forEach(button => {
                button.onclick = (event) => {
                    const productId = event.target.dataset.productId || event.target.closest('button').dataset.productId; // Handle icon click
                    const input = productCategoryContentDiv.querySelector(`.quantity-input[data-product-id="${productId}"]`);
                    let quantity = parseInt(input.value);
                    if (event.target.dataset.action === 'increase' || event.target.closest('button').dataset.action === 'increase') {
                        quantity++;
                    } else if ((event.target.dataset.action === 'decrease' || event.target.closest('button').dataset.action === 'decrease') && quantity > 1) {
                        quantity--;
                    }
                    input.value = quantity;
                };
            });

            productCategoryContentDiv.querySelectorAll('.add-to-order-btn').forEach(button => {
                button.onclick = (event) => {
                    const productId = event.target.dataset.productId || event.target.closest('button').dataset.productId; // Handle icon click
                    const input = productCategoryContentDiv.querySelector(`.quantity-input[data-product-id="${productId}"]`);
                    const quantity = parseInt(input.value);
                    if (quantity > 0) {
                        addToOrder(productId, quantity);
                        input.value = 1; // Reset quantity after adding to order
                    } else {
                        alert('La cantidad debe ser al menos 1.');
                    }
                };
            });
        }

        function addToOrder(productId, quantity) {
            const product = productos.find(p => p.id === productId);
            if (product) {
                const existingItemIndex = currentOrder.items.findIndex(item => item.product.id === productId);
                if (existingItemIndex !== -1) {
                    // Update quantity if item already exists
                    currentOrder.items[existingItemIndex].cantidad += quantity;
                } else {
                    // When adding a new product to order, include all its defined modifiers by default
                    const selectedModifiers = product.modifiers ? JSON.parse(JSON.stringify(product.modifiers)) : [];
                    currentOrder.items.push({
                        product: product,
                        cantidad: quantity,
                        selectedModifiers: selectedModifiers // Store selected modifiers
                    });
                }
                updateCurrentOrderDisplay();
            }
        }

        function updateCurrentOrderDisplay() {
            currentOrderItemsDiv.innerHTML = '';
            currentOrder.total = 0;
            if (currentOrder.items.length === 0) {
                currentOrderItemsDiv.innerHTML = '<p class="text-gray-500">No hay productos en el pedido.</p>';
                currentOrderTotalSpan.textContent = '$0.00';
                return;
            }

            currentOrder.items.forEach((item, itemIndex) => {
                let itemTotalPrice = item.product.precio * item.cantidad;
                let modifiersDisplay = '';

                if (item.selectedModifiers && item.selectedModifiers.length > 0) {
                    modifiersDisplay = item.selectedModifiers.map((mod, modIndex) => {
                        itemTotalPrice += mod.price * item.cantidad; // Add modifier price to item total
                        return `<span class="text-xs text-gray-600 ms-2">${mod.name} ($${mod.price.toFixed(2)}) <button class="btn btn-danger btn-sm remove-selected-modifier" data-item-index="${itemIndex}" data-mod-index="${modIndex}"><i class="bi bi-x"></i></button></span>`;
                    }).join('');
                    modifiersDisplay = `<div class="d-flex flex-wrap align-items-center mt-1">${modifiersDisplay}</div>`;
                }

                const itemDiv = document.createElement('div');
                itemDiv.className = 'd-flex flex-column bg-white p-2 rounded shadow-sm';
                itemDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-gray-700">${item.cantidad}x ${item.product.nombre}</span>
                        <span class="fw-medium text-gray-800">$${itemTotalPrice.toFixed(2)}</span>
                        <button class="btn btn-danger btn-sm remove-order-item-btn" data-index="${itemIndex}"><i class="bi bi-x"></i></button>
                    </div>
                    ${modifiersDisplay}
                `;
                currentOrderItemsDiv.appendChild(itemDiv);
                currentOrder.total += itemTotalPrice; // Add item's total (including modifiers) to order total
            });
            currentOrderTotalSpan.textContent = `$${currentOrder.total.toFixed(2)}`;

            // Add event listeners for removing items from the order
            currentOrderItemsDiv.querySelectorAll('.remove-order-item-btn').forEach(button => {
                button.onclick = (event) => {
                    const indexToRemove = parseInt(event.target.dataset.index || event.target.closest('button').dataset.index);
                    currentOrder.items.splice(indexToRemove, 1);
                    updateCurrentOrderDisplay();
                };
            });

            // Add event listeners for removing selected modifiers
            currentOrderItemsDiv.querySelectorAll('.remove-selected-modifier').forEach(button => {
                button.onclick = (event) => {
                    const itemIndex = parseInt(event.target.dataset.itemIndex || event.target.closest('button').dataset.itemIndex);
                    const modIndex = parseInt(event.target.dataset.modIndex || event.target.closest('button').dataset.modIndex);
                    if (currentOrder.items[itemIndex] && currentOrder.items[itemIndex].selectedModifiers) {
                        currentOrder.items[itemIndex].selectedModifiers.splice(modIndex, 1);
                        updateCurrentOrderDisplay();
                    }
                };
            });
        }

        function placeOrder() {
            if (currentOrder.items.length === 0) {
                alert('El pedido está vacío. Por favor, agrega productos.');
                return;
            }

            const newOrder = {
                id: 'pedido_' + Date.now(),
                fecha: new Date().toISOString(),
                // Deep copy items and their selectedModifiers
                items: currentOrder.items.map(item => ({
                    product: { ...item.product }, // Copy product details
                    cantidad: item.cantidad,
                    selectedModifiers: JSON.parse(JSON.stringify(item.selectedModifiers || [])) // Deep copy selected modifiers
                })),
                total: currentOrder.total,
                estado: 'Pendiente' // 'Pendiente', 'En Proceso', 'Entregado'
            };

            pedidos.push(newOrder);
            guardarEnLocalStorage('pedidos', pedidos);
            renderAllOrders();

            // Reset current order
            currentOrder.items = [];
            currentOrder.total = 0;
            updateCurrentOrderDisplay();
            alert(`Pedido #${newOrder.id.split('_')[1]} realizado y en cola.`);
        }

        function renderAllOrders() {
            // Clear all nested order content divs before re-rendering
            pendingOrdersDiv.innerHTML = '';
            inProcessOrdersDiv.innerHTML = '';
            deliveredOrdersDiv.innerHTML = '';

            // Sort orders by date, oldest first
            const sortedPedidos = [...pedidos].sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

            sortedPedidos.forEach(order => {
                let orderItemsHtml = '';
                let orderTotalWithModifiers = 0;

                order.items.forEach(item => {
                    let itemDisplayPrice = item.product.precio;
                    let itemModifiersHtml = '';
                    if (item.selectedModifiers && item.selectedModifiers.length > 0) {
                        itemModifiersHtml = item.selectedModifiers.map(mod => {
                            itemDisplayPrice += mod.price;
                            return `<span class="text-xs text-gray-500 ms-2">${mod.name} ($${mod.price.toFixed(2)})</span>`;
                        }).join('');
                        itemModifiersHtml = `<div class="d-flex flex-wrap">${itemModifiersHtml}</div>`;
                    }
                    orderItemsHtml += `<li>${item.cantidad}x ${item.product.nombre} ($${(item.cantidad * itemDisplayPrice).toFixed(2)}) ${itemModifiersHtml}</li>`;
                    orderTotalWithModifiers += (item.cantidad * itemDisplayPrice);
                });


                const orderCard = document.createElement('div');
                orderCard.className = 'card p-4 mb-2';
                orderCard.innerHTML = `
                    <h4 class="fw-bold text-lg text-gray-800 mb-2">Pedido #${order.id.split('_')[1]}</h4>
                    <p class="text-sm text-gray-600">Fecha: ${new Date(order.fecha).toLocaleString()}</p>
                    <ul class="list-disc list-inside text-gray-700 text-sm mb-2">
                        ${orderItemsHtml}
                    </ul>
                    <p class="fw-semibold text-gray-800">Total: $${orderTotalWithModifiers.toFixed(2)}</p>
                    <div class="mt-3 d-flex flex-wrap gap-2">
                        ${order.estado === 'Pendiente' ?
                            `<button class="btn btn-warning btn-sm" onclick="changeOrderStatus('${order.id}', 'En Proceso')">Enviar a Proceso</button>` : ''}
                        ${order.estado === 'En Proceso' ?
                            `<button class="btn btn-success btn-sm" onclick="changeOrderStatus('${order.id}', 'Entregado')">Marcar Entregado</button>` : ''}
                        ${order.estado === 'Entregado' ?
                            `<button class="btn btn-primary btn-sm" onclick="completeSale('${order.id}')">Cobrar y Finalizar</button>` : ''}
                        <button class="btn btn-danger btn-sm" onclick="cancelOrder('${order.id}')">Cancelar</button>
                    </div>
                `;

                if (order.estado === 'Pendiente') {
                    pendingOrdersDiv.appendChild(orderCard);
                } else if (order.estado === 'En Proceso') {
                    inProcessOrdersDiv.appendChild(orderCard);
                } else if (order.estado === 'Entregado') {
                    deliveredOrdersDiv.appendChild(orderCard);
                }
            });
            // Display message if no orders in a section
            if (pendingOrdersDiv.innerHTML === '') pendingOrdersDiv.innerHTML = '<p class="text-gray-500 text-center">No hay pedidos pendientes.</p>';
            if (inProcessOrdersDiv.innerHTML === '') inProcessOrdersDiv.innerHTML = '<p class="text-gray-500 text-center">No hay pedidos en proceso.</p>';
            if (deliveredOrdersDiv.innerHTML === '') deliveredOrdersDiv.innerHTML = '<p class="text-gray-500 text-center">No hay pedidos entregados.</p>';
        }

        function changeOrderStatus(orderId, newStatus) {
            const orderIndex = pedidos.findIndex(o => o.id === orderId);
            if (orderIndex !== -1) {
                pedidos[orderIndex].estado = newStatus;
                guardarEnLocalStorage('pedidos', pedidos);
                renderAllOrders();
            }
        }

        function completeSale(orderId) {
            const orderIndex = pedidos.findIndex(o => o.id === orderId);
            if (orderIndex !== -1) {
                const completedOrder = pedidos[orderIndex];

                // Simulate payment method selection
                const metodoPago = prompt("Método de pago (Efectivo/Tarjeta):", "Efectivo");
                if (!metodoPago) {
                    alert("Cobro cancelado.");
                    return;
                }

                // Recalculate total including modifiers for the final sale record
                let finalSaleTotal = 0;
                const productsSoldWithModifiers = completedOrder.items.map(item => {
                    let itemPriceIncludingModifiers = item.product.precio;
                    if (item.selectedModifiers && item.selectedModifiers.length > 0) {
                        item.selectedModifiers.forEach(mod => {
                            itemPriceIncludingModifiers += mod.price;
                        });
                    }
                    finalSaleTotal += item.cantidad * itemPriceIncludingModifiers;

                    return {
                        id: item.product.id,
                        nombre: item.product.nombre,
                        descripcion: item.product.descripcion, // Added product description
                        cantidad: item.cantidad,
                        precioUnitario: item.product.precio, // Base price
                        selectedModifiers: JSON.parse(JSON.stringify(item.selectedModifiers || [])) // Store selected modifiers
                    };
                });


                const nuevaVenta = {
                    id: 'venta_' + Date.now(),
                    fecha: completedOrder.fecha, // Use original order date
                    total: finalSaleTotal, // Use the recalculated total
                    metodoPago: metodoPago,
                    productosVendidos: productsSoldWithModifiers
                };

                ventas.push(nuevaVenta);
                guardarEnLocalStorage('ventas', ventas);

                // Remove the order from the active orders list
                pedidos.splice(orderIndex, 1);
                guardarEnLocalStorage('pedidos', pedidos);

                renderAllOrders();
                alert(`Venta de $${nuevaVenta.total.toFixed(2)} registrada exitosamente.`);
            }
        }

        function cancelOrder(orderId) {
            if (confirm('¿Estás seguro de que quieres cancelar este pedido?')) {
                pedidos = pedidos.filter(order => order.id !== orderId);
                guardarEnLocalStorage('pedidos', pedidos);
                renderAllOrders();
                alert('Pedido cancelado.');
            }
        }

        // --- Sales Reports ---

        function generateMonthlyReport() {
            const mes = parseInt(reportMonthSelect.value);
            const anio = parseInt(reportYearInput.value);

            if (isNaN(mes) || isNaN(anio)) {
                alert('Por favor, selecciona un mes y un año válidos.');
                return;
            }

            const todasLasVentas = obtenerDeLocalStorage('ventas');
            const ventasDelMes = todasLasVentas.filter(venta => {
                const fechaVenta = new Date(venta.fecha);
                return fechaVenta.getMonth() + 1 === mes && fechaVenta.getFullYear() === anio;
            });

            let totalIngresos = 0;
            let cantidadVentas = ventasDelMes.length;
            let productosMasVendidos = {}; // { "Product Name": totalQuantitySold }

            ventasDelMes.forEach(venta => {
                totalIngresos += venta.total; // Total already includes modifiers
                venta.productosVendidos.forEach(item => {
                    // Count base product
                    productosMasVendidos[item.nombre] = (productosMasVendidos[item.nombre] || 0) + item.cantidad;
                    // Count modifiers as separate items for "most sold" if desired, or just sum their prices
                    if (item.selectedModifiers) {
                        item.selectedModifiers.forEach(mod => {
                            productosMasVendidos[`${item.nombre} (${mod.name})`] = (productosMasVendidos[`${item.nombre} (${mod.name})`] || 0) + item.cantidad;
                        });
                    }
                });
            });

            const topProducts = Object.entries(productosMasVendidos)
                .sort(([, a], [, b]) => b - a) // Sort from highest to lowest quantity
                .map(([nombre, cantidad]) => ({ nombre, cantidad }));

            renderReport(totalIngresos, cantidadVentas, topProducts, ventasDelMes);
        }

        function renderReport(totalIngresos, cantidadVentas, topProducts, ventasDetalle) {
            reportTotalSalesP.textContent = `Total de Ingresos: $${totalIngresos.toFixed(2)}`;
            reportNumSalesP.textContent = `Número de Ventas: ${cantidadVentas}`;

            topProductsListUl.innerHTML = '';
            if (topProducts.length > 0) {
                topProducts.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.nombre}: ${item.cantidad} unidades`;
                    topProductsListUl.appendChild(li);
                });
            } else {
                topProductsListUl.innerHTML = '<li class="text-gray-500">No hay productos vendidos en este período.</li>';
            }


            salesDetailTableBody.innerHTML = '';
            if (ventasDetalle.length > 0) {
                ventasDetalle.forEach(venta => {
                    const row = salesDetailTableBody.insertRow();
                    row.insertCell().textContent = venta.id.split('_')[1];
                    row.insertCell().textContent = new Date(venta.fecha).toLocaleString();
                    row.insertCell().textContent = `$${venta.total.toFixed(2)}`;
                    row.insertCell().textContent = venta.metodoPago;
                    const productsCell = row.insertCell();
                    let productsHtml = venta.productosVendidos.map(p => {
                        let modHtml = '';
                        if (p.selectedModifiers && p.selectedModifiers.length > 0) {
                            modHtml = p.selectedModifiers.map(m => `${m.name} ($${m.price.toFixed(2)})`).join(', ');
                            modHtml = ` <span class="text-xs text-gray-500">(${modHtml})</span>`;
                        }
                        return `${p.cantidad}x ${p.nombre}${modHtml}`;
                    }).join('<br>');
                    productsCell.innerHTML = productsHtml;

                    const actionsCell = row.insertCell();
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger btn-sm';
                    deleteBtn.innerHTML = '<i class="bi bi-trash"></i>'; // Bootstrap trash icon
                    deleteBtn.title = 'Eliminar Venta';
                    deleteBtn.onclick = () => deleteSale(venta.id);
                    actionsCell.appendChild(deleteBtn);
                });
            } else {
                const row = salesDetailTableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 6; // Increased colspan to account for new Actions column
                cell.textContent = 'No hay ventas registradas para este período.';
                cell.className = 'text-center text-gray-500 py-4';
            }
        }

        function deleteSale(saleId) {
            if (confirm('¿Estás seguro de que quieres eliminar esta venta? Esta acción no se puede deshacer.')) {
                ventas = ventas.filter(venta => venta.id !== saleId);
                guardarEnLocalStorage('ventas', ventas);
                generateMonthlyReport(); // Re-render the report after deletion
                alert('Venta eliminada exitosamente.');
            }
        }


        // --- Export/Import Functions ---
        function exportSalesData() {
            const data = obtenerDeLocalStorage('ventas');
            if (data.length === 0) {
                alert('No hay datos de ventas para exportar.');
                return;
            }
            const jsonString = JSON.stringify(data, null, 2); // Pretty print JSON
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ventas_backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Datos de ventas exportados exitosamente.');
        }

        function importSalesData(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) {
                        throw new Error('El archivo JSON no contiene un array válido de ventas.');
                    }
                    // Optional: Add more robust validation for the structure of importedData
                    if (!confirm('¿Estás seguro de que quieres importar estos datos? Esto sobrescribirá tus ventas actuales.')) {
                        return;
                    }
                    ventas = importedData;
                    guardarEnLocalStorage('ventas', ventas);
                    alert('Datos de ventas importados exitosamente. Genera un nuevo reporte para ver los cambios.');
                    // Re-render report with new data
                    generateMonthlyReport();
                } catch (error) {
                    console.error("Error al importar datos:", error);
                    alert(`Error al importar el archivo: ${error.message}. Asegúrate de que sea un archivo JSON válido.`);
                }
            };
            reader.readAsText(file);
        }


        // --- Event Listeners ---
        saveProductBtn.addEventListener('click', saveProduct);
        cancelEditBtn.addEventListener('click', cancelEdit);
        addCategoryBtn.addEventListener('click', addCategory);
        addModifierInputBtn.addEventListener('click', () => addModifierInput());
        placeOrderBtn.addEventListener('click', placeOrder);
        generateReportBtn.addEventListener('click', generateMonthlyReport);

        // Export/Import Event Listeners
        exportSalesBtn.addEventListener('click', exportSalesData);
        importSalesBtn.addEventListener('click', () => importSalesFile.click());
        importSalesFile.addEventListener('change', importSalesData);

        // Initialize the app when the DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
