---
layout:
permalink: transfer-liga-indigo
title: REGISTRO DE EQUIPO
inscripcion: true
bgColor: indigo
---

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - Torneos & Kit Bienvenida</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Librer칤a para generar las im치genes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Fuentes Gaming -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@300..700&display=swap" rel="stylesheet">

    <style>
        .jugador-item { font-size: 0.875rem; }
        .capitan-tag { color: #0d6efd; font-weight: bold; }

        /* ESTILOS DEL BANNER OCULTO */
        #banner-container-hidden { position: fixed; top: -9999px; left: -9999px; }
        
        .esports-banner {
            width: 1200px; height: 400px;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            position: relative; overflow: hidden;
            font-family: 'Teko', sans-serif; color: white;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-transform: uppercase; border: 2px solid #4a4a4a;
        }
        .esports-banner::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 10% 20%, rgba(76, 29, 149, 0.4) 0%, transparent 20%),
                        radial-gradient(circle at 90% 80%, rgba(13, 110, 253, 0.2) 0%, transparent 20%);
            z-index: 1;
        }
        .esports-banner .banner-bg-text {
            position: absolute; font-size: 250px; font-weight: 900; opacity: 0.03;
            white-space: nowrap; z-index: 0; top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-10deg);
        }
        .esports-banner .content { z-index: 10; text-align: center; width: 100%; }
        .esports-banner .team-tag-badge {
            background: #0d6efd; color: white; padding: 5px 20px;
            font-size: 30px; font-weight: bold; letter-spacing: 4px;
            display: inline-block; transform: skew(-15deg); margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(13, 110, 253, 0.5);
        }
        .esports-banner .player-nick {
            font-size: 120px; line-height: 1; font-weight: 700; margin: 0;
            text-shadow: 4px 4px 0px #000; letter-spacing: 2px;
        }
        .esports-banner .team-name {
            font-size: 40px; font-weight: 300; letter-spacing: 8px;
            margin-top: 10px; color: #ccc;
        }
        .esports-banner .footer-bar {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 15px;
            background: linear-gradient(90deg, #0d6efd, #6610f2);
        }
        
        /* Preview Area */
        #preview-area {
            width: 100%; overflow-x: auto; border: 1px solid #ccc;
            margin-bottom: 1rem; background: #eee; text-align: center; padding: 10px;
        }
        #preview-img { max-width: 100%; height: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }

        /* Auth Overlay */
        #auth-status { font-weight: bold; }
        .unauthorized-blur { filter: blur(5px); pointer-events: none; user-select: none; }
    </style>
</head>

<body class="bg-light">

    <!-- === LOGIN MODAL (Si no est치s logueado) === -->
    <div class="modal fade" id="modalLogin" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">游댏 Acceso Requerido (Admin)</h5>
                </div>
                <div class="modal-body">
                    <p class="small text-muted">Las reglas de Firebase requieren que seas administrador para leer los equipos.</p>
                    <form id="formLogin">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" id="loginEmail" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contrase침a</label>
                            <input type="password" id="loginPassword" class="form-control" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Iniciar Sesi칩n</button>
                        </div>
                        <div id="loginError" class="text-danger mt-2 text-center" style="display:none;"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- === BARRA DE ESTADO === -->
    <div class="container-fluid bg-dark text-white py-2 mb-3">
        <div class="container d-flex justify-content-between align-items-center">
            <span>Panel Admin</span>
            <div>
                <span id="auth-status" class="me-3">游댮 Desconectado</span>
                <button id="btnLogout" class="btn btn-sm btn-outline-light" style="display:none;">Salir</button>
            </div>
        </div>
    </div>

    <div class="container py-4" id="main-content">
        <h2 class="mb-4">游늵 Panel de Administraci칩n de Temporadas</h2>

        <!-- Selector de temporadas -->
        <div class="row mb-4">
            <div class="col-md-6">
                <label for="tempOrigen" class="form-label">Temporada origen</label>
                <select id="tempOrigen" class="form-select"></select>
            </div>
            <div class="col-md-6">
                <label for="tempDestino" class="form-label">Temporada destino</label>
                <select id="tempDestino" class="form-select"></select>
            </div>
        </div>

        <!-- Bot칩n para cargar equipos -->
        <button id="btnCargarEquipos" class="btn btn-primary mb-4" disabled>Cargar Equipos (Requiere Login)</button>

        <!-- Lista de equipos -->
        <div id="equiposList" class="row gy-3"></div>
    </div>

    <!-- === ELEMENTO OCULTO: LIENZO PARA GENERAR EL BANNER === -->
    <div id="banner-container-hidden">
        <div id="banner-render" class="esports-banner">
            <div class="banner-bg-text" id="banner-bg-text">TEAM</div>
            <div class="content">
                <div class="team-tag-badge" id="banner-tag">TAG</div>
                <h1 class="player-nick" id="banner-nick">NICKNAME</h1>
                <h2 class="team-name" id="banner-team">NOMBRE DEL EQUIPO</h2>
            </div>
            <div class="footer-bar"></div>
        </div>
    </div>

    <!-- === MODAL KIT DE BIENVENIDA === -->
    <div class="modal fade" id="modalKitBienvenida" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">游꿛 Generador de Kit de Bienvenida</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4 border-end">
                            <h6>Selecciona un jugador:</h6>
                            <div class="list-group" id="listaJugadoresBanner"></div>
                        </div>
                        <div class="col-md-8">
                            <h6>Vista Previa:</h6>
                            <div id="preview-area">
                                <img id="preview-img" src="" style="display:none;">
                                <div id="preview-placeholder" class="text-muted py-5">Selecciona un jugador...</div>
                            </div>
                            <div class="d-grid gap-2">
                                <button id="btnDescargarBanner" class="btn btn-success" disabled>拘勇 Descargar Banner</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de edici칩n -->
    <div class="modal fade" id="modalEditarEquipo" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Equipo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditarEquipo">
                        <input type="hidden" id="editDocId">
                        <input type="hidden" id="editTemp">
                        <div class="mb-3"><label>Nombre</label><input type="text" id="editNombreEquipo" class="form-control" required></div>
                        <div class="mb-3"><label>Tag</label><input type="text" id="editTagEquipo" class="form-control" required></div>
                        <div class="mb-3"><label>Contacto</label><input type="text" id="editContacto" class="form-control"></div>
                        <div class="mb-3"><label>Link</label><input type="text" id="editLink" class="form-control"></div>
                        <div class="mb-3"><label>Grupo</label><input type="text" id="editGrupo" class="form-control"></div>
                        <div class="mb-3"><label>Regi칩n</label><input type="text" id="editRegion" class="form-control"></div>
                        <h6>Jugadores</h6>
                        <div id="editJugadoresContainer"></div>
                        <button type="button" id="btnAgregarJugadorEdit" class="btn btn-sm btn-outline-primary mt-2">+ Agregar</button>
                        <div class="mt-3 d-grid"><button type="submit" class="btn btn-success">Guardar</button></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Plantilla -->
    {% raw %}
    <script id="equipoTemplate" type="text/template">
    <div class="col-12 col-md-6 col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">{{nombreEquipo}} <small class="text-muted">({{tagEquipo}})</small></h5>
          <p class="mb-2 small"><strong>Capit치n:</strong> {{capitanNombre}}</p>
          <div class="jugadores-list mb-3 flex-grow-1">
             <small class="text-muted">Jugadores: {{totalJugadores}}</small>
          </div>
          <div class="mt-auto">
            <div class="d-grid gap-2 mb-2">
                <button class="btn btn-dark btn-sm kit-btn" data-id="{{docId}}" data-temp="{{tempOrigen}}">游꿛 Generar Kit Bienvenida</button>
            </div>
            <div class="d-flex gap-2 flex-wrap justify-content-center">
                <button class="btn btn-sm btn-outline-primary editar-btn" data-id="{{docId}}" data-temp="{{tempOrigen}}">Editar</button>
                <button class="btn btn-sm btn-outline-success transferir-btn" data-id="{{docId}}" data-temp="{{tempOrigen}}">Mover</button>
                <button class="btn btn-sm btn-outline-danger eliminar-btn" data-id="{{docId}}" data-temp="{{tempOrigen}}">Eliminar</button>
                <button class="btn btn-sm btn-outline-info descargar-json-btn" data-id="{{docId}}" data-temp="{{tempOrigen}}">JSON</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    </script>
    {% endraw %}

    <!-- SCRIPT MODULAR -->
    {% raw %}
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { 
            getFirestore, collection, getDocs, getDoc, doc, deleteDoc, addDoc, updateDoc 
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { 
            getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut 
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXznASeaw8vtU6OWwiP2kkVBh0L0b45y4",
            authDomain: "unite-mex.firebaseapp.com",
            projectId: "unite-mex",
            storageBucket: "unite-mex.appspot.com",
            messagingSenderId: "248961873504",
            appId: "1:248961873504:web:b9ad5434d6a1041bc73505"
        };

        // INICIALIZACI칍N
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // VARIABLES UI
        const modalLogin = new bootstrap.Modal(document.getElementById('modalLogin'));
        const btnLogout = document.getElementById('btnLogout');
        const authStatus = document.getElementById('auth-status');
        const mainContent = document.getElementById('main-content');
        const btnCargar = document.getElementById("btnCargarEquipos");

        // === GESTI칍N DE AUTENTICACI칍N ===
        
        // 1. Escuchar cambios de estado (Login/Logout)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuario logueado
                console.log("Usuario conectado:", user.uid);
                authStatus.textContent = `游릭 Admin: ${user.email}`;
                btnLogout.style.display = 'inline-block';
                btnCargar.disabled = false;
                btnCargar.textContent = "Cargar Equipos";
                mainContent.classList.remove('unauthorized-blur');
                modalLogin.hide();
            } else {
                // Usuario desconectado
                console.log("No hay usuario.");
                authStatus.textContent = "游댮 Desconectado";
                btnLogout.style.display = 'none';
                btnCargar.disabled = true;
                btnCargar.textContent = "游 Requiere Login";
                // mainContent.classList.add('unauthorized-blur'); // Opcional: desenfocar fondo
                modalLogin.show(); // Forzar login
            }
        });

        // 2. Manejar formulario de Login
        document.getElementById('formLogin').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPassword').value;
            const errorMsg = document.getElementById('loginError');

            try {
                errorMsg.style.display = 'none';
                await signInWithEmailAndPassword(auth, email, pass);
                // El onAuthStateChanged se encargar치 de cerrar el modal
            } catch (error) {
                console.error(error);
                errorMsg.textContent = "Error: " + error.message;
                errorMsg.style.display = 'block';
            }
        });

        // 3. Manejar Logout
        btnLogout.addEventListener('click', () => signOut(auth));

        // === L칍GICA ORIGINAL (EQUIPOS) ===
        const TEMPORADAS = [
            "insEnero", "insFebrero", "insMarzo", "insAbril",
            "insMayo", "insJunio", "insJulio", "insAgosto", "equipos",
            "insSeptiembre", "insOctubre", "insNoviembre", "insDiciembre"
        ];

        const selectOrigen = document.getElementById("tempOrigen");
        const selectDestino = document.getElementById("tempDestino");

        TEMPORADAS.forEach(temp => {
            const opt1 = document.createElement("option");
            opt1.value = temp;
            opt1.textContent = temp.replace("ins", "");
            selectOrigen.appendChild(opt1);
            const opt2 = opt1.cloneNode(true);
            selectDestino.appendChild(opt2);
        });

        // Cargar Equipos
        btnCargar.addEventListener("click", async () => {
            if(!auth.currentUser) return Swal.fire("Error", "Debes iniciar sesi칩n", "error");

            const tempOrigen = selectOrigen.value;
            const contenedor = document.getElementById("equiposList");
            contenedor.innerHTML = '<div class="col-12 text-center">Cargando...</div>';

            try {
                const querySnapshot = await getDocs(collection(db, tempOrigen));
                contenedor.innerHTML = "";

                if (querySnapshot.empty) {
                    contenedor.innerHTML = '<div class="alert alert-info">No hay equipos aqu칤.</div>';
                    return;
                }

                const template = document.getElementById("equipoTemplate").textContent;

                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    let html = template; 
                    const safe = (val) => val ?? "N/A";

                    html = html.replace(/{{nombreEquipo}}/g, safe(data.nombreEquipo));
                    html = html.replace(/{{tagEquipo}}/g, safe(data.tagEquipo));
                    html = html.replace(/{{capitanNombre}}/g, safe(data.capitanNombre || data.capit치nNombre));
                    html = html.replace(/{{docId}}/g, docSnap.id);
                    html = html.replace(/{{tempOrigen}}/g, tempOrigen);
                    html = html.replace(/{{totalJugadores}}/g, data.jugadores ? data.jugadores.length : 0);

                    contenedor.insertAdjacentHTML("beforeend", html);
                });

            } catch (error) {
                console.error("Error:", error);
                if(error.code === 'permission-denied') {
                    Swal.fire("Acceso Denegado", "Tu usuario no tiene permisos de Admin (UID incorrecto).", "error");
                } else {
                    Swal.fire("Error", "No se pudieron cargar los equipos", "error");
                }
            }
        });

        // Delegaci칩n de Eventos (Botones)
        document.getElementById("equiposList").addEventListener("click", async (e) => {
            const btn = e.target;
            const docId = btn.dataset.id;
            const tempOrigen = btn.dataset.temp;

            if (btn.classList.contains("editar-btn")) await cargarEquipoParaEditar(tempOrigen, docId);
            if (btn.classList.contains("kit-btn")) await abrirModalKit(tempOrigen, docId);
            // ... (resto de botones igual)
        });

        // === GENERADOR DE KIT ===
        async function abrirModalKit(temp, docId) {
             try {
                const docSnap = await getDoc(doc(db, temp, docId));
                if (!docSnap.exists()) return;
                const equipo = docSnap.data();
                
                const lista = document.getElementById("listaJugadoresBanner");
                lista.innerHTML = "";
                document.getElementById("preview-img").style.display = "none";
                document.getElementById("preview-placeholder").style.display = "block";
                document.getElementById("btnDescargarBanner").disabled = true;

                if (equipo.jugadores) {
                    equipo.jugadores.forEach(jugador => {
                        const item = document.createElement("button");
                        item.className = "list-group-item list-group-item-action";
                        item.innerHTML = `<strong>${jugador.nickname}</strong> <small>(${jugador.rol})</small>`;
                        item.onclick = () => generarVistaPrevia(jugador, equipo);
                        lista.appendChild(item);
                    });
                }
                new bootstrap.Modal(document.getElementById('modalKitBienvenida')).show();
            } catch (e) { console.error(e); }
        }

        function generarVistaPrevia(jugador, equipo) {
            document.getElementById('banner-nick').textContent = jugador.nickname;
            document.getElementById('banner-team').textContent = equipo.nombreEquipo;
            document.getElementById('banner-tag').textContent = equipo.tagEquipo;
            document.getElementById('banner-bg-text').textContent = equipo.tagEquipo;
            
            const btn = document.getElementById("btnDescargarBanner");
            btn.textContent = "Generando...";
            
            html2canvas(document.getElementById('banner-render'), { scale: 2, backgroundColor: null }).then(canvas => {
                const imgData = canvas.toDataURL("image/png");
                const previewImg = document.getElementById("preview-img");
                previewImg.src = imgData;
                previewImg.style.display = "block";
                document.getElementById("preview-placeholder").style.display = "none";
                
                btn.disabled = false;
                btn.textContent = `拘勇 Descargar ${jugador.nickname}`;
                btn.onclick = () => {
                    const a = document.createElement("a");
                    a.href = imgData;
                    a.download = `Banner_${equipo.tagEquipo}_${jugador.nickname}.png`;
                    a.click();
                };
            });
        }

        // FUNCIONES AUXILIARES DE EDICI칍N (Simplificadas para espacio)
        function crearInputJugador(j = null) {
             return `<div class="jugador-edit border p-2 mb-2 row g-2">
                <div class="col-3"><input class="form-control nombre-jugador" value="${j?.nickname||''}" placeholder="Nick"></div>
                <div class="col-3"><select class="form-select rol-jugador">
                    <option value="ADC"${j?.rol=='ADC'?' selected':''}>ADC</option>
                    <option value="Top"${j?.rol=='Top'?' selected':''}>Top</option>
                    <option value="Jungle"${j?.rol=='Jungle'?' selected':''}>Jungla</option>
                    <option value="Auxiliar"${j?.rol=='Auxiliar'?' selected':''}>Auxiliar</option>
                    <option value="Defensivo"${j?.rol=='Defensivo'?' selected':''}>Defensivo</option>
                </select></div>
                <div class="col-3"><input class="form-control id-jugador" value="${j?.ID||''}" placeholder="ID"></div>
                <div class="col-2"><input type="checkbox" class="capitan-check" ${j?.esCapitan?'checked':''}> Cap</div>
                <div class="col-1"><button type="button" class="btn btn-danger btn-sm btn-eliminar-jugador">X</button></div>
             </div>`;
        }
        
        // Delegaci칩n eliminar jugador
        document.getElementById("editJugadoresContainer").addEventListener("click", e => {
            if(e.target.classList.contains("btn-eliminar-jugador")) e.target.closest(".jugador-edit").remove();
        });
        document.getElementById("btnAgregarJugadorEdit").addEventListener("click", () => {
            document.getElementById("editJugadoresContainer").insertAdjacentHTML("beforeend", crearInputJugador());
        });

        async function cargarEquipoParaEditar(temp, docId) {
            const docSnap = await getDoc(doc(db, temp, docId));
            if (!docSnap.exists()) return;
            const d = docSnap.data();
            document.getElementById("editDocId").value = docId;
            document.getElementById("editTemp").value = temp;
            document.getElementById("editNombreEquipo").value = d.nombreEquipo;
            document.getElementById("editTagEquipo").value = d.tagEquipo;
            document.getElementById("editContacto").value = d.contacto || "";
            document.getElementById("editLink").value = d.link || "";
            document.getElementById("editGrupo").value = d.grupo || "";
            document.getElementById("editRegion").value = d.region || "";
            
            const c = document.getElementById("editJugadoresContainer");
            c.innerHTML = "";
            if(d.jugadores) d.jugadores.forEach(j => c.insertAdjacentHTML("beforeend", crearInputJugador(j)));
            new bootstrap.Modal(document.getElementById('modalEditarEquipo')).show();
        }
        
        document.getElementById("formEditarEquipo").addEventListener("submit", async e => {
            e.preventDefault();
            const docId = document.getElementById("editDocId").value;
            const temp = document.getElementById("editTemp").value;
            // Recolectar jugadores... (L칩gica simplificada, aseg칰rate de validar inputs)
            const divs = document.querySelectorAll(".jugador-edit");
            const jugadores = [];
            let capitanNombre = "";
            divs.forEach(d => {
                const nick = d.querySelector(".nombre-jugador").value;
                const rol = d.querySelector(".rol-jugador").value;
                const id = d.querySelector(".id-jugador").value;
                const cap = d.querySelector(".capitan-check").checked;
                if(nick) {
                    jugadores.push({nickname: nick, rol: rol, ID: id, esCapitan: cap});
                    if(cap) capitanNombre = nick;
                }
            });

            await updateDoc(doc(db, temp, docId), {
                nombreEquipo: document.getElementById("editNombreEquipo").value,
                tagEquipo: document.getElementById("editTagEquipo").value,
                contacto: document.getElementById("editContacto").value,
                link: document.getElementById("editLink").value,
                grupo: document.getElementById("editGrupo").value,
                region: document.getElementById("editRegion").value,
                jugadores: jugadores,
                capitanNombre: capitanNombre
            });
            Swal.fire("Guardado", "", "success");
            bootstrap.Modal.getInstance(document.getElementById('modalEditarEquipo')).hide();
            btnCargar.click();
        });

        console.log("Sistema cargado. Esperando login...");
    </script>
    {% endraw %}
</body>
</html>