---
layout:
permalink: transfer-liga-indigo
title: REGISTRO DE EQUIPO
inscripcion: true
bgColor: indigo
---

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - Torneos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .jugador-item {
            font-size: 0.875rem;
        }

        .capitan-tag {
            color: #0d6efd;
            font-weight: bold;
        }
    </style>
</head>

<body class="bg-light">

    <div class="container py-4">

        <h2 class="mb-4">üìä Panel de Administraci√≥n de Temporadas</h2>

        <!-- Selector de temporadas -->
        <div class="row mb-4">
            <div class="col-md-6">
                <label for="tempOrigen" class="form-label">Temporada origen</label>
                <select id="tempOrigen" class="form-select"></select>
            </div>
            <div class="col-md-6">
                <label for="tempDestino" class="form-label">Temporada destino</label>
                <select id="tempDestino" class="form-select"></select>
            </div>
        </div>

        <!-- Bot√≥n para cargar equipos -->
        <button id="btnCargarEquipos" class="btn btn-primary mb-4">Cargar Equipos</button>

        <!-- Lista de equipos -->
        <div id="equiposList" class="row gy-3"></div>
    </div>

    <!-- Campo de b√∫squeda -->


    <!-- Modal de edici√≥n -->
    <div class="modal fade" id="modalEditarEquipo" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Equipo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditarEquipo">
                        <input type="hidden" id="editDocId">
                        <input type="hidden" id="editTemp">

                        <div class="mb-3">
                            <label class="form-label">Nombre del equipo</label>
                            <input type="text" id="editNombreEquipo" class="form-control" maxlength="20" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tag (m√°x. 5 letras)</label>
                            <input type="text" id="editTagEquipo" class="form-control" maxlength="5" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Contacto (WhatsApp, 10 d√≠gitos)</label>
                            <input type="text" id="editContacto" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Link</label>
                            <input type="text" id="editLink" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Grupo</label>
                            <input type="text" id="editGrupo" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Regi√≥n</label>
                            <input type="text" id="editRegion" class="form-control" required>
                        </div>

                        <h6>Jugadores (m√≠n. 5, m√°x. 9)</h6>
                        <div id="editJugadoresContainer"></div>
                        <button type="button" id="btnAgregarJugadorEdit" class="btn btn-sm btn-outline-primary mt-2">+
                            Agregar jugador</button>

                        <div class="mt-3 d-grid">
                            <button type="submit" class="btn btn-success">Guardar cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS (requerido para modales, etc.) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Plantilla de equipo -->
    {% raw %}
    <script id="equipoTemplate" type="text/template">
    <div class="col-12 col-md-6 col-lg-4">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">{{nombreEquipo}} <small class="text-muted">({{tagEquipo}})</small></h5>
          <p class="mb-2"><strong>Contacto:</strong> {{contacto}}</p>
          <p class="mb-2"><strong>Capit√°n:</strong> {{capitanNombre}}</p>
          <p class="mb-2"><strong>Link:</strong> {{link}}</p>
          <p class="mb-2"><strong>Grupo:</strong> {{grupo}}</p>
          <p class="mb-2"><strong>Region:</strong> {{region}}</p>
          <p class="mb-2"><strong>Jugadores:</strong></p>
          <div class="jugadores-list mb-3">
            {{jugadoresHtml}}
          </div>
           <div class="d-flex gap-2 flex-wrap">
        <button class="btn btn-sm btn-outline-primary editar-btn" data-id="{{docId}}" data-temp="{{tempOrigen}}">Editar</button>
        <button class="btn btn-sm btn-outline-success transferir-btn" data-id="{{docId}}" data-temp="{{tempOrigen}}">Mover a otra temporada</button>
        <button class="btn btn-sm btn-outline-danger eliminar-btn" data-id="{{docId}}" data-temp="{{tempOrigen}}">Eliminar</button>
      </div>
        </div>
      </div>
    </div>
    </script>
    {% endraw %}
    {% raw %}
    <script type="module">
        // === IMPORTS ===
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import {
            getFirestore,
            collection,
            getDocs,
            getDoc,
            doc,
            deleteDoc,
            addDoc,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // === CONFIGURACI√ìN FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyBXznASeaw8vtU6OWwiP2kkVBh0L0b45y4",
            authDomain: "unite-mex.firebaseapp.com",
            projectId: "unite-mex",
            storageBucket: "unite-mex.appspot.com",
            messagingSenderId: "248961873504",
            appId: "1:248961873504:web:b9ad5434d6a1041bc73505"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // === TEMPORADAS DISPONIBLES ===
        const TEMPORADAS = [
            "insEnero", "insFebrero", "insMarzo", "insAbril",
            "insMayo", "insJunio", "insJulio", "insAgosto", "equipos",
            "insSeptiembre", "insOctubre", "insNoviembre", "insDiciembre"
        ];

        const selectOrigen = document.getElementById("tempOrigen");
        const selectDestino = document.getElementById("tempDestino");

        TEMPORADAS.forEach(temp => {
            const opt1 = document.createElement("option");
            opt1.value = temp;
            opt1.textContent = temp.replace("ins", "");
            selectOrigen.appendChild(opt1);

            const opt2 = document.createElement("option");
            opt2.value = temp;
            opt2.textContent = temp.replace("ins", "");
            selectDestino.appendChild(opt2);
        });

        // === CARGAR EQUIPOS ===
        document.getElementById("btnCargarEquipos").addEventListener("click", async () => {
            const tempOrigen = selectOrigen.value;
            const contenedor = document.getElementById("equiposList");
            contenedor.innerHTML = '<div class="col-12 text-center">Cargando...</div>';

            try {
                const querySnapshot = await getDocs(collection(db, tempOrigen));
                contenedor.innerHTML = "";

                if (querySnapshot.empty) {
                    contenedor.innerHTML = '<div class="col-12"><div class="alert alert-info">No hay equipos en esta temporada.</div></div>';
                    return;
                }

                const template = document.getElementById("equipoTemplate").textContent;

                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    let html = template; // ‚úÖ CORREGIDO

                    const safe = (val) => val ?? "N/A";

                    html = html.replace(/{{nombreEquipo}}/g, safe(data.nombreEquipo));
                    html = html.replace(/{{tagEquipo}}/g, safe(data.tagEquipo));
                    html = html.replace(/{{contacto}}/g, safe(data.contacto));
                    html = html.replace(/{{link}}/g, safe(data.link));
                    html = html.replace(/{{grupo}}/g, safe(data.grupo));
                    html = html.replace(/{{region}}/g, safe(data.region));
                    html = html.replace(/{{capitanNombre}}/g, safe(data.capitanNombre || data.capit√°nNombre));
                    html = html.replace(/{{docId}}/g, docSnap.id);
                    html = html.replace(/{{tempOrigen}}/g, tempOrigen);

                    let jugadoresHtml = "";
                    if (Array.isArray(data.jugadores)) {
                        data.jugadores.forEach(j => {
                            const capitanTag = j.esCapitan ? ' <span class="capitan-tag">Capit√°n</span>' : '';
                            jugadoresHtml += `<div class="jugador-item">${safe(j.nickname)} (${safe(j.rol)}) - ${safe(j.ID)}${capitanTag}</div>`;
                        });
                    }

                    html = html.replace(/{{jugadoresHtml}}/g, jugadoresHtml);
                    contenedor.insertAdjacentHTML("beforeend", html);
                });

            } catch (error) {
                console.error("Error al cargar equipos:", error);
                Swal.fire("Error", "No se pudieron cargar los equipos", "error");
            }
        });

        // === DELEGACI√ìN DE EVENTOS ===
        document.getElementById("equiposList").addEventListener("click", async (e) => {
            const btn = e.target;
            const docId = btn.dataset.id;
            const tempOrigen = btn.dataset.temp;

            if (btn.classList.contains("editar-btn")) {
                await cargarEquipoParaEditar(tempOrigen, docId);
                return; // salir temprano
            }

            if (btn.classList.contains("transferir-btn")) {
                const tempDestino = selectDestino.value;
                if (tempOrigen === tempDestino) {
                    Swal.fire("Advertencia", "No puedes mover a la misma temporada", "warning");
                    return;
                }

                try {
                    const equipoRef = doc(db, tempOrigen, docId);
                    const equipoSnap = await getDoc(equipoRef);

                    if (!equipoSnap.exists()) throw new Error("Equipo no encontrado");

                    const equipoData = equipoSnap.data();

                    await addDoc(collection(db, tempDestino), equipoData);
                    // ‚úÖ Si quieres que se elimine del origen, descomenta:
                    // await deleteDoc(equipoRef);

                    Swal.fire("√âxito", "Equipo movido correctamente", "success");
                    document.getElementById("btnCargarEquipos").click();

                } catch (error) {
                    console.error("Error al mover:", error);
                    Swal.fire("Error", "No se pudo mover el equipo", "error");
                }
            }

            if (btn.classList.contains("eliminar-btn")) {
                const confirm = await Swal.fire({
                    title: "¬øEliminar?",
                    text: "Esta acci√≥n no se puede deshacer.",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "S√≠, eliminar",
                    cancelButtonText: "Cancelar"
                });

                if (confirm.isConfirmed) {
                    try {
                        await deleteDoc(doc(db, tempOrigen, docId));
                        Swal.fire("Eliminado", "Equipo eliminado", "success");
                        document.getElementById("btnCargarEquipos").click();
                    } catch (error) {
                        console.error("Error al eliminar:", error);
                        Swal.fire("Error", "No se pudo eliminar", "error");
                    }
                }
            }
        });

        // === FUNCIONES DE EDICI√ìN ===

        // Plantilla para un jugador editable
        function crearInputJugador(jugador = null, index = 0) {
            const esCapitan = jugador?.esCapitan || false;
            return `
    <div class="jugador-edit border rounded p-2 mb-2">
      <div class="row g-2">
        <div class="col-md-3">
          <input type="text" class="form-control nombre-jugador" placeholder="Nombre" 
                 value="${jugador?.nickname || ''}" maxlength="12" required>
        </div>
        <div class="col-md-3">
          <select class="form-select rol-jugador" required>
            <option value="">Rol</option>
            <option value="ADC" ${jugador?.rol === 'ADC' ? 'selected' : ''}>ADC</option>
            <option value="Auxiliar" ${jugador?.rol === 'Auxiliar' ? 'selected' : ''}>Auxiliar</option>
            <option value="Top" ${jugador?.rol === 'Top' ? 'selected' : ''}>Top</option>
            <option value="Defensivo" ${jugador?.rol === 'Defensivo' ? 'selected' : ''}>Defensivo</option>
            <option value="Jungle" ${jugador?.rol === 'Jungle' ? 'selected' : ''}>Jungla</option>
          </select>
        </div>
        <div class="col-md-3">
          <input type="text" class="form-control id-jugador" placeholder="ID juego" 
                 value="${jugador?.ID || ''}" maxlength="7" required>
        </div>
        <div class="col-md-2">
          <div class="form-check mt-2">
            <input class="form-check-input capitan-check" type="checkbox" ${esCapitan ? 'checked' : ''}>
            <label class="form-check-label">Capit√°n</label>
          </div>
        </div>
        <div class="col-md-1 d-flex align-items-center">
          <button type="button" class="btn btn-sm btn-outline-danger btn-eliminar-jugador">üóëÔ∏è</button>
        </div>
      </div>
    </div>
  `;
        }

        // Manejar selecci√≥n de capit√°n (solo uno)
        function manejarCapitanCheck(container) {
            container.addEventListener('change', (e) => {
                if (e.target.classList.contains('capitan-check') && e.target.checked) {
                    container.querySelectorAll('.capitan-check').forEach(cb => {
                        if (cb !== e.target) cb.checked = false;
                    });
                }
            });
        }

        // Cargar equipo para editar
        async function cargarEquipoParaEditar(temp, docId) {
            try {
                const docSnap = await getDoc(doc(db, temp, docId));
                if (!docSnap.exists()) {
                    Swal.fire("Error", "Equipo no encontrado", "error");
                    return;
                }

                const data = docSnap.data();

                // Rellenar campos principales
                document.getElementById("editDocId").value = docId;
                document.getElementById("editTemp").value = temp;
                document.getElementById("editNombreEquipo").value = data.nombreEquipo || "";
                document.getElementById("editTagEquipo").value = data.tagEquipo || "";
                document.getElementById("editContacto").value = data.contacto || "";
                document.getElementById("editLink").value = data.link || "";
                document.getElementById("editGrupo").value = data.grupo || "";
                document.getElementById("editRegion").value = data.region || "";

                // Limpiar y cargar jugadores
                const container = document.getElementById("editJugadoresContainer");
                container.innerHTML = "";

                if (Array.isArray(data.jugadores)) {
                    data.jugadores.forEach(j => {
                        container.insertAdjacentHTML("beforeend", crearInputJugador(j));
                    });
                }

                // Activar manejo de capit√°n
                manejarCapitanCheck(container);

                // Mostrar modal
                // ‚úÖ Usa el m√©todo est√°ndar de Bootstrap 5
                const modalElement = document.getElementById('modalEditarEquipo');
                const modal = new window.bootstrap.Modal(modalElement);
                modal.show();

            } catch (error) {
                console.error("Error al cargar equipo para editar:", error);
                Swal.fire("Error", "No se pudo cargar el equipo", "error");
            }
        }

        // Validar que haya exactamente un capit√°n
        function validarCapitan(container) {
            const checks = container.querySelectorAll('.capitan-check:checked');
            return checks.length === 1;
        }

        // Reemplaza el listener submit existente por este
        document.getElementById("formEditarEquipo").addEventListener("submit", async (e) => {
            e.preventDefault();

            const container = document.getElementById("editJugadoresContainer");
            const jugadoresInputs = container.querySelectorAll(".jugador-edit");

            // Validaciones de cantidad
            if (jugadoresInputs.length < 5 || jugadoresInputs.length > 10) {
                Swal.fire("Error", "El equipo debe tener entre 5 y 10 jugadores", "error");
                return;
            }

            // Validar capit√°n √∫nico
            if (!validarCapitan(container)) {
                Swal.fire("Error", "Debes seleccionar exactamente un capit√°n", "error");
                return;
            }

            // Recopilar datos de jugadores (usar for para permitir return correcto)
            const jugadores = [];
            let capitanNombre = "";

            for (let i = 0; i < jugadoresInputs.length; i++) {
                const div = jugadoresInputs[i];
                const nickname = (div.querySelector(".nombre-jugador")?.value || "").trim();
                const rol = (div.querySelector(".rol-jugador")?.value || "").trim();
                const ID = (div.querySelector(".id-jugador")?.value || "").trim();
                const esCapitan = !!div.querySelector(".capitan-check")?.checked;

                if (!nickname || !rol || !ID) {
                    Swal.fire("Error", "Todos los campos de jugadores son requeridos", "error");
                    return;
                }

                jugadores.push({ nickname, rol, ID, esCapitan });
                if (esCapitan) capitanNombre = nickname;
            }

            // Datos del equipo actualizados
            const equipoActualizado = {
                nombreEquipo: document.getElementById("editNombreEquipo").value.trim(),
                tagEquipo: document.getElementById("editTagEquipo").value.trim(),
                contacto: document.getElementById("editContacto").value.replace(/\D/g, ''),
                link: document.getElementById("editLink").value.trim(),
                grupo: document.getElementById("editGrupo").value.trim(),
                region: document.getElementById("editRegion").value.trim(),
                jugadores,
                capitanNombre,
                fechaActualizacion: new Date().toISOString()
            };

            // Guardar en Firestore
            try {
                const docId = document.getElementById("editDocId").value;
                const temp = document.getElementById("editTemp").value;

                Swal.fire({
                    title: "Guardando cambios...",
                    html: "Por favor espera ‚è≥",
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                await updateDoc(doc(db, temp, docId), equipoActualizado);

                // Cerrar loader y mostrar √©xito
                Swal.close();
                await Swal.fire({
                    icon: "success",
                    title: "Equipo actualizado",
                    text: "Los cambios se guardaron correctamente ‚úÖ",
                    showConfirmButton: false,
                    timer: 1200,
                    timerProgressBar: true
                });

                // Cerrar modal y recargar lista
                const modalEl = document.getElementById('modalEditarEquipo');
                const modalInst = bootstrap.Modal.getInstance(modalEl);
                if (modalInst) modalInst.hide();

                // Recarga suave de la lista
                document.getElementById("btnCargarEquipos").click();

            } catch (error) {
                console.error("Error al guardar:", error);

                if (error?.code === "permission-denied") {
                    Swal.fire("Permisos insuficientes", "Tu usuario no puede editar esta colecci√≥n", "error");
                } else {
                    Swal.fire("Error", "No se pudieron guardar los cambios", "error");
                }
            }
        });


        // Agregar jugador en edici√≥n
        document.getElementById("btnAgregarJugadorEdit").addEventListener("click", () => {
            const container = document.getElementById("editJugadoresContainer");
            if (container.querySelectorAll(".jugador-edit").length >= 9) {
                Swal.fire("L√≠mite", "M√°ximo 10 jugadores", "warning");
                return;
            }
            container.insertAdjacentHTML("beforeend", crearInputJugador());
            manejarCapitanCheck(container);
        });

        // Eliminar jugador en edici√≥n (delegaci√≥n)
        document.getElementById("editJugadoresContainer").addEventListener("click", (e) => {
            if (e.target.classList.contains("btn-eliminar-jugador")) {
                e.target.closest(".jugador-edit").remove();
            }
        });


        console.log("Firebase cargado:", app ? "‚úÖ" : "‚ùå");
        console.log("DB:", db);
    </script>
    {% endraw %}
</body>

</html>